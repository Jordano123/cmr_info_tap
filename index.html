<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CMR Hub</title>
  
  <link rel="icon" type="image/png" sizes="512x512" href="/cmr512.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/cmr192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/cmr180.png">
  <style>
    /* Minimal, safe styles to match a compact app-like hub */
    :root {
      --bg: #ffffff;
      --muted: #6b7280;
      --card-border: rgba(15,23,42,0.06);
      --accent: #0b5fff;
      --radius: 10px;
      --gap: 12px;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body { margin:0; background:var(--bg); color:#0f172a; line-height:1.35; padding:16px; }
    .container { max-width:900px; margin:0 auto; display:flex; flex-direction:column; gap:16px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    h1 { font-size:20px; margin:0; }
    .card { background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95)); padding:14px; border-radius:var(--radius); border:1px solid var(--card-border); box-shadow:0 1px 0 rgba(15,23,42,0.02); }
    .card h2 { margin:0 0 8px 0; font-size:16px; }
    .small-muted { color:var(--muted); font-size:13px; }
    .btn { background:var(--accent); color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; text-decoration:none; display:inline-block; font-weight:700; }
    .btn-ghost { background:#fff; border:1px solid var(--card-border); padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:700; color:inherit; text-decoration:none; }
    #sermonVideoWrap { width:100%; aspect-ratio:16/9; background:#000; border-radius:8px; overflow:hidden; display:flex; align-items:center; justify-content:center; color:#fff; }
    .leaders-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:12px; align-items:start; }
    .leader-card { display:flex; flex-direction:column; align-items:center; gap:8px; text-align:center; padding:8px; }
    .leader-card img { width:96px; height:96px; object-fit:cover; border-radius:12px; }
    .event-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .address-row { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    @media(min-width:900px){
      .layout { display:grid; grid-template-columns: 1fr 320px; gap:16px; align-items:start; }
      .right-col { display:flex; flex-direction:column; gap:16px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>CMR Hub</h1>
        <div class="small-muted">All you need in one place</div>
      </div>
      <nav aria-label="Hub actions">
        <a class="btn-ghost" href="/give">Give</a>
        <a class="btn-ghost" href="/listen">Listen</a>
        <a class="btn-ghost" href="/connect">Connect</a>
      </nav>
    </header>

    <main class="layout" id="mainLayout">
      <!-- Left column -->
      <div id="leftCol">
        <!-- Latest Sermon (single) -->
        <section id="latestSermonCard" class="card" aria-labelledby="latestSermonHeading">
          <h2 id="latestSermonHeading">Latest Sermon</h2>
          <div id="sermonVideoWrap" aria-live="polite">
            <!-- thumbnail or iframe injected by JS -->
            <div class="small-muted">Loading latest sermon…</div>
          </div>
          <div style="margin-top:10px;">
            <div id="sermonTitle" style="font-weight:700; font-size:15px;"></div>
            <div id="sermonDetails" class="small-muted" style="margin-top:4px;"></div>
            <div class="event-actions" style="margin-top:8px;">
              <button id="shareSermonBtn" class="btn-ghost" aria-label="Share sermon">Share</button>
              <button id="copySermonLinkBtn" class="btn-ghost" aria-label="Copy link">Copy link</button>
              <a id="openSermonOnYT" class="btn-ghost" target="_blank" rel="noopener" aria-label="Open on YouTube">Open on YouTube</a>
            </div>
          </div>
        </section>

        <!-- Announcements placeholder -->
        <section id="announcements" class="card" aria-labelledby="announcementsHeading">
          <h2 id="announcementsHeading">Announcements</h2>
          <div id="announcementsList" class="small-muted">No announcements right now.</div>
        </section>

        <!-- Leaders -->
        <section id="leadersSection" class="card" aria-labelledby="leadersHeading">
          <h2 id="leadersHeading">Leaders</h2>
          <div id="leadersGrid" class="leaders-grid" aria-live="polite">
            <!-- leader cards injected by JS -->
            <div class="small-muted">Loading leaders…</div>
          </div>
        </section>

        <!-- Service Times -->
        <section id="serviceTimes" class="card" aria-labelledby="serviceTimesHeading">
          <h2 id="serviceTimesHeading">Service Times</h2>
          <div>
            <div style="font-weight:700;">Sunday • 9:00 AM</div>
            <div style="font-weight:700; margin-top:6px;">Sunday • 11:00 AM</div>
            <div class="small-muted" style="margin-top:8px;">Childcare available at both services</div>
          </div>
        </section>

        <!-- Address + Directions -->
        <section id="addressSection" class="card" aria-labelledby="addressHeading">
          <h2 id="addressHeading">Visit Us</h2>
          <div class="address-row">
            <div>
              <div style="font-weight:700;">Christ Missionary Revival Church</div>
              <div class="small-muted">123 Church St, Fort Worth, TX</div>
            </div>
            <div>
              <button id="directionsBtn" class="btn" aria-label="Get directions">Directions</button>
            </div>
          </div>
        </section>
      </div>

      <!-- Right column (announcements + optional extras on desktop) -->
      <aside class="right-col" id="rightCol">
        <!-- Keep announcements also visible on right for desktop if desired -->
        <div class="card">
          <h2>Quick Links</h2>
          <div style="display:flex; flex-direction:column; gap:8px;">
            <a class="btn-ghost" href="/follow">Follow Us</a>
            <a class="btn-ghost" href="/visit">Visit Website</a>
            <a class="btn-ghost" href="/give">Give</a>
          </div>
        </div>

        <div class="card">
          <h2>Upcoming Event</h2>
          <div id="nextEvent" class="small-muted">No upcoming events.</div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    /* CONFIG: update these coordinates and labels if needed */
    const CHURCH_LAT = 32.7555;
    const CHURCH_LNG = -97.3308;
    const CHURCH_LABEL = 'Christ Missionary Revival Church';

    /* Directions button: open Apple Maps on iOS, Google Maps otherwise */
    function openDirections(lat, lng, label) {
      const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
      const apple = `maps://?q=${encodeURIComponent(label)}&ll=${lat},${lng}`;
      const google = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
      window.location.href = isIOS ? apple : google;
    }
    document.getElementById('directionsBtn').addEventListener('click', () => {
      openDirections(CHURCH_LAT, CHURCH_LNG, CHURCH_LABEL);
    });

    /* Load sermons.json and render only the newest sermon */
    async function loadSingleLatestSermon() {
      const wrap = document.getElementById('sermonVideoWrap');
      const titleEl = document.getElementById('sermonTitle');
      const detailsEl = document.getElementById('sermonDetails');
      const openBtn = document.getElementById('openSermonOnYT');
      const shareBtn = document.getElementById('shareSermonBtn');
      const copyBtn = document.getElementById('copySermonLinkBtn');

      try {
        const res = await fetch('/sermons.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('Failed to load sermons.json');
        const data = await res.json();
        const items = (data.items || []).filter(i => i.videoId && i.date);
        if (!items.length) throw new Error('No sermons found');

        items.sort((a,b) => new Date(b.date) - new Date(a.date));
        const latest = items[0];

        // Optional: show thumbnail first, then swap to iframe on click for performance
        if (latest.thumbnail) {
          const img = document.createElement('img');
          img.src = latest.thumbnail;
          img.alt = latest.title || 'Latest sermon thumbnail';
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          img.style.cursor = 'pointer';
          wrap.innerHTML = '';
          wrap.appendChild(img);
          img.addEventListener('click', () => {
            renderIframe(latest.videoId, wrap, latest.title);
          });
        } else {
          renderIframe(latest.videoId, wrap, latest.title);
        }

        titleEl.textContent = latest.title || 'Latest Sermon';
        const dateStr = latest.date ? new Date(latest.date).toLocaleDateString() : '';
        detailsEl.textContent = `${latest.preacher || ''}${latest.preacher ? ' • ' : ''}${dateStr}`;

        const videoUrl = `https://www.youtube.com/watch?v=${latest.videoId}`;
        openBtn.href = videoUrl;

        shareBtn.onclick = async () => {
          const shareData = { title: latest.title, text: latest.title, url: videoUrl };
          if (navigator.share) {
            try { await navigator.share(shareData); return; } catch (e) { /* fallback */ }
          }
          const fb = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(videoUrl)}`;
          window.open(fb, '_blank', 'noopener');
        };

        copyBtn.onclick = async () => {
          try {
            await navigator.clipboard.writeText(videoUrl);
            copyBtn.textContent = 'Copied';
            setTimeout(() => copyBtn.textContent = 'Copy link', 1600);
          } catch (e) {
            prompt('Copy this link', videoUrl);
          }
        };

      } catch (err) {
        console.error(err);
        wrap.innerHTML = '';
        titleEl.textContent = 'Latest sermon unavailable';
        detailsEl.textContent = 'Visit our YouTube channel for recent messages.';
        openBtn.href = '/';
      }
    }

    function renderIframe(videoId, wrap, title) {
      wrap.innerHTML = '';
      const iframe = document.createElement('iframe');
      iframe.src = `https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1`;
      iframe.title = title || 'Latest sermon';
      iframe.loading = 'lazy';
      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
      iframe.allowFullscreen = true;
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframe.style.border = '0';
      wrap.appendChild(iframe);
    }

    /* Load leaders.json and render a small grid of leader cards */
    async function loadLeaders() {
      const grid = document.getElementById('leadersGrid');
      try {
        const res = await fetch('/leaders.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('Failed to load leaders.json');
        const data = await res.json();
        const items = (data.items || []).filter(Boolean);
        if (!items.length) {
          grid.innerHTML = '<div class="small-muted">No leaders listed.</div>';
          return;
        }
        grid.innerHTML = '';
        items.forEach(l => {
          const card = document.createElement('div');
          card.className = 'leader-card';
          const img = document.createElement('img');
          img.src = l.photo || '/step.png';
          img.alt = l.name || 'Leader';
          img.width = 96;
          img.height = 96;
          const name = document.createElement('div');
          name.textContent = l.name || '';
          name.style.fontWeight = '700';
          const role = document.createElement('div');
          role.className = 'small-muted';
          role.textContent = l.role || '';
          card.appendChild(img);
          card.appendChild(name);
          card.appendChild(role);
          grid.appendChild(card);
        });
      } catch (err) {
        console.error(err);
        grid.innerHTML = '<div class="small-muted">Could not load leaders.</div>';
      }
    }

    /* Load next upcoming event from events.json if present (optional) */
    async function loadNextEvent() {
      const target = document.getElementById('nextEvent');
      try {
        const res = await fetch('/events.json', { cache: 'no-store' });
        if (!res.ok) { target.textContent = 'No upcoming events.'; return; }
        const data = await res.json();
        const items = (data.items || []).filter(e => e.public !== false);
        const now = new Date();
        const upcoming = items
          .map(e => ({...e, start: new Date(`${e.date}T${e.startTime || '00:00'}`)}))
          .filter(e => e.start >= now)
          .sort((a,b) => a.start - b.start);
        if (!upcoming.length) { target.textContent = 'No upcoming events.'; return; }
        const next = upcoming[0];
        target.innerHTML = `<div style="font-weight:700;">${next.title}</div>
          <div class="small-muted">${new Date(next.date).toLocaleDateString()} • ${next.startTime || ''}</div>
          <div style="margin-top:6px;">${next.location || ''}</div>
          <div class="event-actions">
            <a class="btn-ghost" href="${toGoogleCalendarUrl(next)}" target="_blank" rel="noopener">Add to Google</a>
            <button class="btn-ghost" onclick='downloadICS(${JSON.stringify(next).replace(/'/g,"\\'")})'>Add to Apple/Outlook</button>
          </div>`;
      } catch (err) {
        console.error(err);
        target.textContent = 'No upcoming events.';
      }
    }

    /* Helper: generate Google Calendar link */
    function toGoogleCalendarUrl(event){
      const start = `${event.date.replace(/-/g,'')}T${(event.startTime||'00:00').replace(':','')}00`;
      const end = event.endTime ? `${event.date.replace(/-/g,'')}T${event.endTime.replace(':','')}00` : `${event.date.replace(/-/g,'')}T${String(Number((event.startTime||'00:00').split(':')[0]) + 1).padStart(2,'0')}${(event.startTime||'00:00').split(':')[1]}00`;
      const params = new URLSearchParams({
        action: 'TEMPLATE',
        text: event.title || '',
        dates: `${start}/${end}`,
        details: event.description || '',
        location: event.location || ''
      });
      return `https://www.google.com/calendar/render?${params.toString()}`;
    }

    /* ICS download generator */
    function downloadICS(event){
      const start = `${event.date.replace(/-/g,'')}T${(event.startTime||'00:00').replace(':','')}00`;
      const end = event.endTime ? `${event.date.replace(/-/g,'')}T${event.endTime.replace(':','')}00` : `${event.date.replace(/-/g,'')}T${String(Number((event.startTime||'00:00').split(':')[0]) + 1).padStart(2,'0')}${(event.startTime||'00:00').split(':')[1]}00`;
      const ics =
`BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
UID:${event.id}@cmrhub
DTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').split('.')[0]}Z
DTSTART:${start}
DTEND:${end}
SUMMARY:${event.title}
DESCRIPTION:${(event.description||'').replace(/\n/g,' ')}
LOCATION:${event.location || ''}
END:VEVENT
END:VCALENDAR`;
      const blob = new Blob([ics], { type: 'text/calendar' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${event.id || 'event'}.ics`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    /* Initialize all */
    document.addEventListener('DOMContentLoaded', () => {
      loadSingleLatestSermon();
      loadLeaders();
      loadNextEvent();
    });
  </script>
</body>
</html>



  <!--<link rel="icon" type="image/x-icon" href="/cmr512.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/cmr32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/cmr32.png">
  <link rel="icon" type="image/svg+xml" href="/cmrsvg.svg">
  <link rel="apple-touch-icon" sizes="180x180" href="/cmr180.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/cmr180.png"> -->
