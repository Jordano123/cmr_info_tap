<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CMR Hub</title>

  <!-- Base styles -->
  <style>
    :root{
      --accent:#2b6cb0;
      --muted:#6b7280;
      --card-bg:#ffffff;
      --page-bg:#f3f4f6;
      --radius:10px;
      --gap:18px;
      --max-width:1100px;
      --container-padding:20px;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html, body { max-width:100%; overflow-x:hidden; box-sizing:border-box; }
    *, *::before, *::after { box-sizing:inherit; }
    img, video { max-width:100%; height:auto; display:block; }

    body{ margin:0; background:var(--page-bg); color:#111827; padding:30px; display:flex; justify-content:center; }
    .wrap{ width:100%; max-width:var(--max-width); padding:var(--container-padding); box-sizing:border-box; position:relative; }

    /* Layout: left column + right column stacked */
    .layout-fixed{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:18px;
      align-items:start;
      width:100%;
      margin:0 auto;
    }
    .left-col{ display:flex; flex-direction:column; gap:18px; }
    .right-col{ display:flex; flex-direction:column; gap:16px; }

    @media (max-width:980px){
      .layout-fixed{ grid-template-columns: 1fr; }
      .right-col{ order:2; }
      .left-col{ order:1; }
    }

    .card{ background:var(--card-bg); border-radius:var(--radius); padding:20px; box-shadow:0 6px 18px rgba(15,23,42,0.06); border:1px solid rgba(15,23,42,0.04); }
    .hub-header{ display:flex; align-items:center; gap:12px; margin-bottom:12px; }
    .hub-logo{ width:32px; height:32px; border-radius:8px; background:#111827; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:16px; }
    .hub-title{ font-size:20px; font-weight:700; margin:0; }
    .hub-subtitle{ font-size:13px; color:var(--muted); margin:0; }

    .hub-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px; }
    @media(max-width:640px){ .hub-grid{ grid-template-columns:repeat(2,1fr); } }

    .hub-button{ background:#f8fafc; border-radius:10px; padding:14px; display:flex; gap:12px; align-items:center; cursor:pointer; border:1px solid transparent; transition:all .12s ease; text-decoration:none; color:inherit; }
    .hub-button:hover{ transform:translateY(-2px); box-shadow:0 6px 18px rgba(15,23,42,0.04); }
    .hub-icon{ width:44px; height:44px; border-radius:8px; background:linear-gradient(135deg,var(--accent),#4c9bd6); display:flex; align-items:center; justify-content:center; color:white; }
    .hub-icon svg{ width:22px; height:22px; stroke-width:2.2; }
    .hub-label{ font-weight:600; font-size:15px; }
    .hub-sub{ font-size:13px; color:var(--muted); }

    .announcement-list{ display:flex; flex-direction:column; gap:16px; }
    .announcement{ display:flex; flex-direction:column; gap:12px; border-radius:10px; padding:14px; background:#f9fafb; border:1px solid #e5e7eb; }
    .announcement .thumb{ width:100%; height:160px; border-radius:8px; object-fit:cover; background:#e6eef9; }
    .meta-row{ display:flex; justify-content:space-between; gap:10px; align-items:center; font-size:13px; color:var(--muted); }
    .announce-title{ font-size:18px; font-weight:700; margin:0; }
    .announce-desc{ font-size:14px; color:#111827; line-height:1.45; }
    .small-muted{ font-size:13px; color:var(--muted); }
    .cta-row{ display:flex; gap:10px; margin-top:8px; }
    .btn{ padding:10px 12px; border-radius:8px; border:1px solid transparent; cursor:pointer; font-weight:600; font-size:14px; text-decoration:none; display:inline-flex; align-items:center; gap:6px; }
    .btn-primary{ background:var(--accent); color:white; }

    .serve-section{ display:flex; flex-direction:column; gap:12px; }
    .serve-group{ display:flex; flex-direction:column; gap:4px; }
    .serve-title{ font-weight:700; font-size:15px; margin:0; }
    .serve-item{ font-size:14px; color:#111827; margin-left:8px; }

    .serve-card { border-radius:12px; padding:18px; display:flex; flex-direction:column; gap:10px; }
    .serve-card .serve-header { display:flex; align-items:center; gap:10px; }
    .serve-card .serve-badge { width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; }

    /* small responsive tweaks */
    @media (max-width:420px){
      .wrap{ padding:12px; }
      .card{ padding:14px; }
    }
  </style>

  <!-- Brand stylesheet (after base styles) -->
  <link rel="stylesheet" href="cmr-brand.css">

  <!-- Feather icons -->
  <script src="https://unpkg.com/feather-icons"></script>
</head>
<body>
  <div class="wrap" id="pageWrap">
    <div class="layout-fixed" id="mainLayout">
      <!-- LEFT COLUMN: Hub + How to Serve -->
      <div class="left-col">
        <!-- CMR HUB CARD -->
        <div class="card" id="hubCard" aria-label="CMR Hub">
          <div class="hub-header">
            <div class="hub-logo" id="logoText">CMR</div>
            <div>
              <h1 class="hub-title" id="hubTitle">CMR Hub</h1>
              <p class="hub-subtitle" id="hubSubtitle">One place for everything happening at CMR.</p>
            </div>
          </div>

          <div class="hub-grid" role="navigation" aria-label="Main actions">
            <!-- Give: attempts app deep link first (configure data-app-href) then falls back to web href -->
            <a class="hub-button" href="https://example.com/give" id="giveBtn" title="Give" data-app-href="paypal://send?recipient=YOUR_PAYPAL_ID">
              <div class="hub-icon"><i data-feather="heart"></i></div>
              <div><div class="hub-label" id="giveLabel">Give</div><div class="hub-sub" id="giveSub">Support online</div></div>
            </a>

            <!-- YouTube: example uses a VIDEO_ID placeholder; replace VIDEO_ID with your sermon video id -->
            <a class="hub-button" href="https://www.youtube.com/watch?v=VIDEO_ID" id="sermonsBtn" title="Sermons" data-app-href="youtube://watch?v=VIDEO_ID" data-android-intent="intent://www.youtube.com/watch?v=VIDEO_ID#Intent;package=com.google.android.youtube;scheme=https;end">
              <div class="hub-icon"><i data-feather="video"></i></div>
              <div><div class="hub-label" id="sermonsLabel">Sermons</div><div class="hub-sub" id="sermonsSub">Watch on YouTube</div></div>
            </a>

            <!-- Listen: opens listen page (audio) -->
            <a class="hub-button" href="listen.html" id="listenBtn" title="Listen">
              <div class="hub-icon"><i data-feather="headphones"></i></div>
              <div><div class="hub-label" id="listenLabel">Listen</div><div class="hub-sub" id="listenSub">Audio highlights</div></div>
            </a>

            <!-- Connect -->
            <a class="hub-button" href="connect.html" id="connectBtn" title="Connect">
              <div class="hub-icon"><i data-feather="user-plus"></i></div>
              <div><div class="hub-label" id="connectLabel">Connect</div><div class="hub-sub" id="connectSub">Fill out the form</div></div>
            </a>

            <!-- Visit website -->
            <a class="hub-button" href="https://example.com" id="visitBtn" title="Visit Website">
              <div class="hub-icon"><i data-feather="globe"></i></div>
              <div><div class="hub-label" id="visitLabel">Visit Website</div><div class="hub-sub" id="visitSub">More info online</div></div>
            </a>

            <!-- Follow / Social -->
            <a class="hub-button" href="https://linktr.ee" id="followBtn" title="Follow Us">
              <div class="hub-icon"><i data-feather="share-2"></i></div>
              <div><div class="hub-label" id="followLabel">Follow Us</div><div class="hub-sub" id="followSub">Social links</div></div>
            </a>
          </div>
        </div>

        <!-- HOW TO SERVE (under Hub) - removed logo/badge next to title per request -->
        <div class="card serve-card" id="serveCard" data-accent="true" aria-label="How to Serve">
          <div class="serve-header" style="align-items:flex-start;">
            <div style="flex:1;">
              <div style="font-weight:700; font-size:16px;">How to Serve</div>
              <div class="small-muted" style="font-size:13px;">Join a team that fits your gifts</div>
            </div>
          </div>

          <div class="serve-section" aria-hidden="false">
            <div class="serve-group">
              <div class="serve-title">Choir</div>
              <div class="serve-item">• Singing (Soprano, Alto, Tenor, Bass)</div>
            </div>

            <div class="serve-group">
              <div class="serve-title">Band</div>
              <div class="serve-item">• Acoustic Guitar</div>
              <div class="serve-item">• Electric Guitar</div>
              <div class="serve-item">• Bass Guitar</div>
              <div class="serve-item">• Drums</div>
              <div class="serve-item">• Tam‑Tam / Percussion</div>
            </div>

            <div class="serve-group">
              <div class="serve-title">Production Team</div>
              <div class="serve-item">• Sound Engineer</div>
              <div class="serve-item">• Video Switcher</div>
              <div class="serve-item">• Slide Operator</div>
              <div class="serve-item">• Camera Operator</div>
            </div>

            <div class="serve-group">
              <div class="serve-title">Creative & Media</div>
              <div class="serve-item">• Photography</div>
              <div class="serve-item">• Social Media</div>
              <div class="serve-item">• Graphic Support</div>
            </div>

            <div class="serve-group">
              <div class="serve-title">Kids Ministry</div>
              <div class="serve-item">• Classroom Helper</div>
              <div class="serve-item">• Check‑In Support</div>
            </div>

            <div class="serve-group">
              <div class="serve-title">Guest Experience</div>
              <div class="serve-item">• Usher / Greeter</div>
              <div class="serve-item">• Welcome Team</div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN: Announcements -->
      <aside class="right-col" aria-label="Right column">
        <!-- Primary announcement slot -->
        <div class="card" id="announcementsCard" aria-live="polite" data-accent="true">
          <h3 id="announcementsTitle" style="margin:0 0 12px 0;">Announcements</h3>
          <div id="announcementContainer"></div>
        </div>

        <!-- Secondary announcement slot (toggleable) -->
        <div class="card" id="announcementsCard2" aria-live="polite" style="display:none;">
          <h3 style="margin:0 0 12px 0;">More Announcements</h3>
          <div id="announcementContainer2"></div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // ---------- CONFIG ----------
    const SHOW_ANNOUNCEMENTS = null; // true | false | null (auto)
    const SHOW_SECOND_ANNOUNCEMENT = null; // true | false | null (auto)
    const ANNOUNCEMENT_JSON_URL = '/announcement.json';

    // translations
    const translations = {
      en: { announcements: "Announcements", more_announcements: "More Announcements", learn_more: "Learn more", no_announcements: "No current announcements" },
      fr: { announcements: "Annonces", more_announcements: "Plus d'annonces", learn_more: "En savoir plus", no_announcements: "Aucune annonce en cours" }
    };
    function getSavedLang(){ return localStorage.getItem('cmr_lang') || 'en'; }

    // language switcher
    const ENABLE_LANGUAGE_SWITCHER = true;
    function createLangSwitcher(){
      if(!ENABLE_LANGUAGE_SWITCHER) return;
      const wrap = document.createElement('div');
      wrap.className = 'lang-switcher';
      const enBtn = document.createElement('button'); enBtn.className = 'lang-btn'; enBtn.textContent = 'EN'; enBtn.onclick = () => { localStorage.setItem('cmr_lang','en'); applyTranslations(); renderAnnouncementsFromData(lastAnnouncementData); };
      const frBtn = document.createElement('button'); frBtn.className = 'lang-btn'; frBtn.textContent = 'FR'; frBtn.onclick = () => { localStorage.setItem('cmr_lang','fr'); applyTranslations(); renderAnnouncementsFromData(lastAnnouncementData); };
      wrap.appendChild(enBtn); wrap.appendChild(frBtn); document.body.appendChild(wrap);
    }
    function applyTranslations(){
      const lang = getSavedLang();
      const t = translations[lang] || translations.en;
      document.getElementById('announcementsTitle').textContent = t.announcements;
      const secH = document.querySelector('#announcementsCard2 h3');
      if(secH) secH.textContent = t.more_announcements;
    }

    // ---------- ANNOUNCEMENT LOGIC ----------
    let lastAnnouncementData = null;
    function isExpired(expireDateStr){ if(!expireDateStr) return false; const now = new Date(); const expire = new Date(expireDateStr + 'T23:59:59'); return now > expire; }

    function renderSingleAnnouncement(containerEl, data, lang){
      if(!containerEl) return;
      containerEl.innerHTML = '';
      const wrapper = document.createElement('div'); wrapper.className = 'announcement';
      const meta = document.createElement('div'); meta.className = 'meta-row';
      const dateSpan = document.createElement('div'); dateSpan.className = 'small-muted'; dateSpan.textContent = data.date || new Date().toLocaleDateString();
      const typeSpan = document.createElement('div'); typeSpan.className = 'small-muted'; typeSpan.textContent = (data.type || 'announcement').toUpperCase();
      meta.appendChild(dateSpan); meta.appendChild(typeSpan); wrapper.appendChild(meta);

      if(data.thumbnail){
        const img = document.createElement('img'); img.className = 'thumb'; img.src = data.thumbnail; img.alt = data.title || 'Announcement image';
        wrapper.appendChild(img);
      }

      const title = document.createElement('h3'); title.className = 'announce-title';
      const titleText = (lang === 'fr' && data.title_fr) ? data.title_fr : data.title || '';
      title.textContent = titleText;
      wrapper.appendChild(title);

      const descText = (lang === 'fr' && data.description_fr) ? data.description_fr : data.description || '';
      if(descText){
        const desc = document.createElement('div'); desc.className = 'announce-desc'; desc.textContent = descText; wrapper.appendChild(desc);
      }

      if(data.extra && (data.extra.location || data.extra.time)){
        const info = document.createElement('div'); info.className = 'small-muted';
        info.textContent = `${data.extra.location ? data.extra.location + ' • ' : ''}${data.extra.time ? data.extra.time : ''}`.trim();
        wrapper.appendChild(info);
      }

      const ctaRow = document.createElement('div'); ctaRow.className = 'cta-row';
      const learn = document.createElement('a'); learn.className = 'btn btn-primary'; learn.href = data.learnMoreUrl || '#'; learn.target = '_blank'; learn.rel = 'noopener';
      learn.textContent = translations[lang].learn_more;
      ctaRow.appendChild(learn); wrapper.appendChild(ctaRow);

      containerEl.appendChild(wrapper);
    }

    function renderAnnouncementsFromData(rawData){
      lastAnnouncementData = rawData;
      const lang = getSavedLang();
      let showAnnouncementsFlag = undefined;
      let items = [];

      if(!rawData){
        items = [];
      } else if(Array.isArray(rawData)){
        items = rawData;
      } else if(typeof rawData === 'object'){
        if(Array.isArray(rawData.items)) items = rawData.items;
        if(rawData.showAnnouncements === false) showAnnouncementsFlag = false;
        if(rawData.showAnnouncements === true) showAnnouncementsFlag = true;
      }

      const active = (items || []).filter(a => a.enabled !== false && !isExpired(a.expireDate));

      const primaryCard = document.getElementById('announcementsCard');
      const secondaryCard = document.getElementById('announcementsCard2');

      if (showAnnouncementsFlag === false) {
        if(primaryCard) primaryCard.style.display = 'none';
        if(secondaryCard) secondaryCard.style.display = 'none';
        return;
      }

      if (SHOW_ANNOUNCEMENTS === false) {
        if(primaryCard) primaryCard.style.display = 'none';
      } else if (SHOW_ANNOUNCEMENTS === true) {
        if(primaryCard) primaryCard.style.display = '';
      } else {
        if(primaryCard) primaryCard.style.display = (active.length > 0) ? '' : 'none';
      }

      if (secondaryCard) {
        if (SHOW_SECOND_ANNOUNCEMENT === true) {
          secondaryCard.style.display = '';
        } else if (SHOW_SECOND_ANNOUNCEMENT === false) {
          secondaryCard.style.display = 'none';
        } else {
          secondaryCard.style.display = (active.length >= 2) ? '' : 'none';
        }
      }

      const primaryContainer = document.getElementById('announcementContainer');
      const secondaryContainer = document.getElementById('announcementContainer2');
      if(primaryContainer) primaryContainer.innerHTML = '';
      if(secondaryContainer) secondaryContainer.innerHTML = '';

      if(active[0] && primaryContainer) renderSingleAnnouncement(primaryContainer, active[0], lang);
      if(active[1] && secondaryContainer) renderSingleAnnouncement(secondaryContainer, active[1], lang);

      if(active.length > 2 && primaryContainer){
        const more = document.createElement('div'); more.className = 'small-muted'; more.style.marginTop = '8px';
        more.textContent = `${active.length - 2} more announcement(s) available.`;
        primaryContainer.appendChild(more);
      }

      if(active.length === 0 && primaryCard && primaryCard.style.display !== 'none' && primaryContainer){
        const placeholder = document.createElement('div'); placeholder.className = 'announcement-placeholder';
        placeholder.textContent = translations[lang].no_announcements;
        primaryContainer.appendChild(placeholder);
      }
    }

    async function loadAndRenderAnnouncements(){
      try{
        const res = await fetch(ANNOUNCEMENT_JSON_URL, { cache: 'no-store' });
        if(!res.ok) throw new Error('Announcement not found');
        const data = await res.json();
        renderAnnouncementsFromData(data);
      }catch(e){
        console.warn('Failed to load announcement.json', e);
        renderAnnouncementsFromData(null);
      }
    }

    // ---------- APP LINK HELPER ----------
    // Generic helper: tries to open an app-specific URL (data-app-href) and falls back to the web href.
    // Works on mobile; desktop will immediately use the web href.
    function tryOpenAppThenFallback(anchor, event){
      // If user used modifier keys or middle click, let default happen
      if (event.metaKey || event.ctrlKey || event.shiftKey || event.button === 1) return;

      const appHref = anchor.getAttribute('data-app-href');
      const androidIntent = anchor.getAttribute('data-android-intent'); // optional Android intent string
      const webHref = anchor.href;

      // Only attempt app open on mobile devices
      const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      if(!isMobile || !appHref) {
        // let the link behave normally (web)
        return;
      }

      event.preventDefault();

      // For Android, prefer intent if provided (works reliably)
      if (/Android/i.test(navigator.userAgent) && androidIntent) {
        window.location = androidIntent;
        // no further fallback here; Android intent will open app or show Play Store
        return;
      }

      // Try to open app scheme and fallback to web after timeout
      const now = Date.now();
      let didHide = false;

      // Listen for page visibility change (user returned to page -> app likely not installed)
      function onVisibilityChange() {
        didHide = document.hidden;
      }
      document.addEventListener('visibilitychange', onVisibilityChange);

      // Attempt to open app via location change
      const timeout = setTimeout(() => {
        document.removeEventListener('visibilitychange', onVisibilityChange);
        // If page didn't become hidden (app didn't open), navigate to web fallback
        if (!didHide) window.location = webHref;
      }, 1200);

      // Try opening app scheme
      try {
        // For iOS, setting window.location to the scheme works
        window.location = appHref;
      } catch (e) {
        clearTimeout(timeout);
        document.removeEventListener('visibilitychange', onVisibilityChange);
        window.location = webHref;
      }
    }

    // Attach app-link behavior to configured hub buttons
    function wireAppLinks(){
      const anchors = document.querySelectorAll('.hub-button[data-app-href]');
      anchors.forEach(a => {
        a.addEventListener('click', function(e){ tryOpenAppThenFallback(a, e); });
      });
    }

    // ---------- INIT ----------
    document.addEventListener('DOMContentLoaded', () => {
      // Replace feather icons after DOM is ready so icons render
      if (window.feather && typeof feather.replace === 'function') {
        feather.replace();
      }
      createLangSwitcher();
      applyTranslations();
      loadAndRenderAnnouncements();
      wireAppLinks();
      setInterval(loadAndRenderAnnouncements, 5 * 60 * 1000);
    });
  </script>
</body>
</html>
