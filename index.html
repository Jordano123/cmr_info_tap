<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CMR Hub</title>
  <link rel="icon" type="image/png" sizes="512x512" href="/cmr512.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/cmr192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/cmr180.png">
  <style>
    :root{
      --accent:#2b6cb0; --muted:#6b7280; --card-bg:#ffffff; --page-bg:#f3f4f6;
      --radius:10px; --gap:18px; --max-width:1100px; --container-padding:20px;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{margin:0;padding:0;width:100%;min-height:100vh;background:var(--page-bg);color:#111827;}
    .wrap{max-width:var(--max-width);margin:0 auto;padding:var(--container-padding);box-sizing:border-box;}
    .layout-fixed{display:grid;grid-template-columns:1fr 360px;gap:18px;align-items:start;}
    @media(max-width:980px){ .layout-fixed{grid-template-columns:1fr;} }
    .card{background:var(--card-bg);border-radius:var(--radius);padding:20px;box-shadow:0 6px 18px rgba(15,23,42,0.06);border:1px solid rgba(15,23,42,0.04);}
    .hub-header{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
    .hub-logo{width:88px;height:88px;border-radius:10px;overflow:hidden;flex:0 0 88px;display:flex;align-items:center;justify-content:center;}
    .hub-logo img{width:100%;height:100%;object-fit:contain;}
    .hub-title{font-size:20px;font-weight:700;margin:0;}
    .hub-subtitle{font-size:13px;color:var(--muted);margin:0;}
    .hub-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
    @media(max-width:640px){ .hub-grid{grid-template-columns:repeat(2,1fr);} }
    .hub-button{display:flex;gap:12px;align-items:center;padding:14px;border-radius:10px;background:#f8fafc;text-decoration:none;color:inherit;}
    .hub-icon{width:44px;height:44px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#4c9bd6);display:flex;align-items:center;justify-content:center;color:#fff;}
    .hub-label{font-weight:600;} .hub-sub{font-size:13px;color:var(--muted);}
    .announcement{display:flex;flex-direction:column;gap:12px;background:#f9fafb;padding:14px;border-radius:10px;border:1px solid #e5e7eb;}
    .meta-row{display:flex;justify-content:space-between;color:var(--muted);font-size:13px;}
    .announce-title{font-weight:700;margin:0;font-size:18px;}
    .announce-desc{font-size:14px;color:#111827;}
    .small-muted{font-size:13px;color:var(--muted);}
    .cta-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;}
    .btn{padding:10px 12px;border-radius:8px;font-weight:600;text-decoration:none;display:inline-flex;align-items:center;gap:8px;cursor:pointer;}
    .btn-primary{background:var(--accent);color:#fff;border:1px solid rgba(0,0,0,0.04);}
    .btn-ghost{background:#fff;border:1px solid rgba(15,23,42,0.06);color:#111827;}
    .btn-youtube{background:#FF0000;color:#fff;border-radius:8px;padding:8px 12px;}
    .leaders-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;}
    .leader-card{display:flex;flex-direction:column;align-items:center;gap:8px;text-align:center;padding:8px;}
    .leader-card img{width:96px;height:96px;object-fit:cover;border-radius:12px;}
    .contact-card{display:flex;flex-direction:column;gap:10px;border-radius:10px;padding:14px;background:#fff;border:1px solid rgba(15,23,42,0.04);box-shadow:0 6px 18px rgba(15,23,42,0.03);}
    .contact-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .contact-btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:700;font-size:14px;border:1px solid rgba(15,23,42,0.06);background:#fff;color:#111827;}
    .contact-btn.phone{background:linear-gradient(90deg,#10b981,#06b6d4);color:#fff;}
    .contact-btn.email{background:linear-gradient(90deg,#6366f1,#8b5cf6);color:#fff;}
    .contact-btn.map{background:linear-gradient(90deg,#f97316,#f43f5e);color:#fff;}
    .contact-meta{color:var(--muted);font-size:13px;}
    .video-thumb{position:relative;cursor:pointer;border-radius:10px;overflow:hidden;background:#000;}
    .video-thumb img{width:100%;height:100%;object-fit:cover;display:block;}
    .play-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;}
    .play-button{width:72px;height:72px;border-radius:50%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;color:#fff;font-size:28px;border:3px solid rgba(255,255,255,0.12);}
    .prayer-card{display:flex;flex-direction:column;gap:10px;border-radius:10px;padding:14px;background:#fff;border:1px solid rgba(15,23,42,0.04);}
    .prayer-meta{color:var(--muted);font-size:13px;}
    .lang-switcher{position:fixed;top:12px;right:12px;display:flex;gap:8px;z-index:9999;}
    .lang-btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:#fff;cursor:pointer;font-weight:700;}
    @media(min-width:981px){ body{display:flex;justify-content:center;} .wrap{box-shadow:0 8px 30px rgba(2,6,23,0.04);border-radius:12px;background:transparent;} }
    @media(max-width:420px){ .hub-logo{width:72px;height:72px;} .card{padding:14px;} }
  </style>
</head>
<body>
  <div class="lang-switcher" id="globalLangSwitcher" aria-hidden="false"></div>

  <div class="wrap" id="pageWrap">
    <div class="layout-fixed" id="mainLayout">
      <div class="left-col" id="leftColumn">
        <div class="card" id="hubCard" aria-label="CMR Hub">
          <div class="hub-header">
            <div class="hub-logo"><img src="logo.png" alt="CMR logo" id="connectLogo"></div>
            <div style="flex:1;">
              <h1 class="hub-title" id="hubTitle">CMR Hub</h1>
              <p class="hub-subtitle" id="hubSubtitle">One place for everything happening at CMR.</p>
            </div>
          </div>

          <div class="hub-grid" role="navigation" aria-label="Main actions">
            <a class="hub-button" href="give.html" id="giveBtn" title="Give">
              <div class="hub-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20.8 4.6c-1.6-1.6-4.2-1.6-5.8 0L12 7.6 9 4.6C7.4 3 4.8 3 3.2 4.6 1.6 6.2 1.6 8.8 3.2 10.4L12 19.2l8.8-8.8c1.6-1.6 1.6-4.2 0-5.8z"/></svg></div>
              <div><div class="hub-label" id="giveLabel">Give</div><div class="hub-sub" id="giveSub">Support online</div></div>
            </a>

            <a class="hub-button" href="https://www.youtube.com/@CentreMissionnaireRestauration" id="sermonsBtn" title="Sermons" data-app-href="https://www.youtube.com/@CentreMissionnaireRestauration">
              <div class="hub-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M23 7L16 12 23 17 23 7zM1 5h14v14H1z"/></svg></div>
              <div><div class="hub-label" id="sermonsLabel">Sermons</div><div class="hub-sub" id="sermonsSub">Watch on YouTube</div></div>
            </a>

            <a class="hub-button" href="listen.html" id="listenBtn" title="Listen">
              <div class="hub-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 1v22M4 7v10M20 7v10"/></svg></div>
              <div><div class="hub-label" id="listenLabel">Listen</div><div class="hub-sub" id="listenSub">Audio highlights</div></div>
            </a>

            <a class="hub-button" href="connect.html" id="connectBtn" title="Connect">
              <div class="hub-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M16 11c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM8 11c1.657 0 3-1.343 3-3S9.657 5 8 5 5 6.343 5 8s1.343 3 3 3zM8 13c-2.667 0-8 1.333-8 4v2h16v-2c0-2.667-5.333-4-8-4zM16 13c-.667 0-2 0-2 1v3h6v-3c0-1-1.333-1-2-1z"/></svg></div>
              <div><div class="hub-label" id="connectLabel">Connect</div><div class="hub-sub" id="connectSub">Fill out the form</div></div>
            </a>

            <a class="hub-button" href="https://cmrestauration.org" id="visitBtn" title="Visit Website">
              <div class="hub-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 2a10 10 0 100 20 10 10 0 000-20z"/></svg></div>
              <div><div class="hub-label" id="visitLabel">Visit Website</div><div class="hub-sub" id="visitSub">More info online</div></div>
            </a>

            <a class="hub-button" href="https://linktr.ee/cmrmediaconnect" id="followBtn" title="Follow Us">
              <div class="hub-icon"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 12h16M4 6h16M4 18h16"/></svg></div>
              <div><div class="hub-label" id="followLabel">Follow Us</div><div class="hub-sub" id="followSub">Social links</div></div>
            </a>
          </div>
        </div>

        <section id="latestSermonCard" class="card" aria-labelledby="latestSermonHeading">
          <h3 id="latestSermonHeading" style="margin:0 0 12px 0;">Latest Sermon</h3>
          <div id="sermonVideoWrap" style="width:100%;aspect-ratio:16/9;border-radius:10px;overflow:hidden;background:#000;">
            <div style="display:flex;align-items:center;justify-content:center;color:#fff;">Loading latest sermon…</div>
          </div>
          <div id="sermonMeta" style="margin-top:10px;">
            <div id="sermonTitle" style="font-weight:700;font-size:16px;"></div>
            <div id="sermonDetails" style="color:var(--muted);font-size:13px;margin-top:4px;"></div>
          </div>
          <div id="sermonActions" style="margin-top:10px;display:flex;gap:8px;align-items:center;">
            <button id="shareSermonBtn" class="btn btn-primary" aria-label="Share sermon">Share</button>
            <button id="copySermonLinkBtn" class="btn btn-primary" aria-label="Copy link">Copy link</button>
            <a id="openSermonOnYT" class="btn btn-youtube" target="_blank" rel="noopener" aria-label="Open on YouTube">Open on YouTube</a>
          </div>
        </section>

        <div class="card" id="biblePlanCard" style="margin-top:12px;">
          <h3 id="biblePlanHeading" style="margin:0 0 12px 0;">Bible in a Year</h3>
          <div style="font-size:14px;color:#374151;margin-bottom:10px;">Follow a one‑year chronological reading plan. Open today’s reading with one tap.</div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <a id="readTodayBtn" class="btn btn-primary" href="https://bibleinayearonline.com/chronological-bible-custom-reading-plan/" target="_blank" rel="noopener">Read Today</a>
            <button id="shareTodayBtn" class="btn btn-ghost">Share Today</button>
            <div id="biblePlanStatus" class="small-muted" style="margin-left:6px;"></div>
          </div>
        </div>

        <div id="announcementsPlaceholder"></div>
        <div id="upcomingPlaceholder"></div>

        <section id="leadersSection" class="card" style="margin-top:12px;">
          <h3 style="margin:0 0 12px 0;">Leaders</h3>
          <div id="leadersGrid" class="leaders-grid" aria-live="polite"><div class="small-muted">Loading leaders…</div></div>
        </section>
      </div>

      <aside class="right-col" id="rightColumn" aria-label="Right column">
        <div class="card" id="announcementsCardPrimary" aria-live="polite" data-accent="true">
          <h3 id="announcementsTitle" style="margin:0 0 12px 0;">Announcements</h3>
          <div id="announcementContainer"></div>
        </div>

        <div class="card" id="announcementsCard2" aria-live="polite" style="margin-top:12px;">
          <h3 style="margin:0 0 12px 0;">More Announcements</h3>
          <div id="announcementContainer2"></div>
        </div>

        <div id="upcomingEventCard" style="margin-top:0;"></div>

        <section id="serviceTimes" class="card" style="margin-top:12px;">
          <h3 id="serviceTimesHeading" style="margin:0 0 12px 0;">Service Times</h3>
          <div>
            <div style="font-weight:700;">Sunday • 9:00 AM</div>
            <div style="font-weight:700;margin-top:6px;">Sunday • 11:00 AM</div>
            <div class="small-muted" style="margin-top:8px;">Childcare available at both services</div>
          </div>
        </section>

        <div id="contactPlaceholder"></div>

        <div class="card" id="announcementsCard3" aria-live="polite" style="display:none;margin-top:12px;">
          <h3 style="margin:0 0 12px 0;">More</h3>
          <div id="announcementContainer3"></div>
        </div>
      </aside>
    </div>

    <footer class="site-footer" role="contentinfo">
      <div>© <span id="currentYear"></span> Christ Missionary Revival Church. All rights reserved.</div>
      <div style="margin-top:6px;color:var(--muted);font-size:12px;">Designed for the CMR community.</div>
    </footer>
  </div>

  <script>
    // ---------- Basic config & translations ----------
    document.getElementById('currentYear').textContent = new Date().getFullYear();
    const ANNOUNCEMENT_JSON_PATH = '/announcement.json';
    const SITE_CONFIG_PATH = '/site-config.json';

    const translations = {
      en: {
        hubTitle:"CMR Hub", hubSubtitle:"One place for everything happening at CMR.",
        giveLabel:"Give", giveSub:"Support online",
        sermonsLabel:"Sermons", sermonsSub:"Watch on YouTube",
        listenLabel:"Listen", listenSub:"Audio highlights",
        connectLabel:"Connect", connectSub:"Fill out the form",
        visitLabel:"Visit Website", visitSub:"More info online",
        followLabel:"Follow Us", followSub:"Social links",
        announcements:"Announcements", more_announcements:"More Announcements", more:"More",
        learn_more:"Learn more", no_announcements:"No current announcements",
        contactHeading:"Contact", contactGetInTouch:"Get in touch", contactMap:"Map", contactCall:"Call", contactEmail:"Email",
        visitUsName:"Christ Missionary Revival Church", visitUsAddress:"123 Church St, Fort Worth, TX",
        prayerHeading:"Prayer Request", prayerSub:"Share a request and we will pray for you", prayerBtn:"Request Prayer"
      },
      fr: {
        hubTitle:"Centre CMR", hubSubtitle:"Un endroit pour tout ce qui se passe à CMR.",
        giveLabel:"Donner", giveSub:"Soutenir en ligne",
        sermonsLabel:"Sermons", sermonsSub:"Regarder sur YouTube",
        listenLabel:"Écouter", listenSub:"Extraits audio",
        connectLabel:"Se connecter", connectSub:"Remplir le formulaire",
        visitLabel:"Visiter le site", visitSub:"Plus d'infos en ligne",
        followLabel:"Suivez-nous", followSub:"Liens sociaux",
        announcements:"Annonces", more_announcements:"Plus d'annonces", more:"Plus",
        learn_more:"En savoir plus", no_announcements:"Aucune annonce en cours",
        contactHeading:"Contact", contactGetInTouch:"Entrer en contact", contactMap:"Carte", contactCall:"Appeler", contactEmail:"Courriel",
        visitUsName:"Christ Missionary Revival Church", visitUsAddress:"123 Church St, Fort Worth, TX",
        prayerHeading:"Demande de prière", prayerSub:"Partagez une demande et nous prierons pour vous", prayerBtn:"Demander la prière"
      }
    };

    function getSavedLang(){ return localStorage.getItem('cmr_lang') || 'en'; }
    function setSavedLang(lang){ localStorage.setItem('cmr_lang', lang); applyTranslations(); renderAnnouncementsFromData(lastAnnouncementData); }
    function buildLangSwitcher(){
      const container = document.getElementById('globalLangSwitcher');
      if(!container) return;
      container.innerHTML = '';
      const enBtn = document.createElement('button'); enBtn.className='lang-btn'; enBtn.textContent='EN'; enBtn.onclick=()=>setSavedLang('en');
      const frBtn = document.createElement('button'); frBtn.className='lang-btn'; frBtn.textContent='FR'; frBtn.onclick=()=>setSavedLang('fr');
      container.appendChild(enBtn); container.appendChild(frBtn);
    }

    function applyTranslations(){
      const lang = getSavedLang();
      const t = translations[lang] || translations.en;
      const safeSet = (id, text) => { const el = document.getElementById(id); if(el) el.textContent = text; };
      safeSet('hubTitle', t.hubTitle); safeSet('hubSubtitle', t.hubSubtitle);
      safeSet('giveLabel', t.giveLabel); safeSet('giveSub', t.giveSub);
      safeSet('sermonsLabel', t.sermonsLabel); safeSet('sermonsSub', t.sermonsSub);
      safeSet('listenLabel', t.listenLabel); safeSet('listenSub', t.listenSub);
      safeSet('connectLabel', t.connectLabel); safeSet('connectSub', t.connectSub);
      safeSet('visitLabel', t.visitLabel); safeSet('visitSub', t.visitSub);
      safeSet('followLabel', t.followLabel); safeSet('followSub', t.followSub);
      const annTitle = document.getElementById('announcementsTitle'); if(annTitle) annTitle.textContent = t.announcements;
      const secH = document.querySelector('#announcementsCard2 h3'); if(secH) secH.textContent = t.more_announcements;
      // contact & prayer translations (if present)
      const prayerHeading = document.querySelector('#prayerCard #prayerHeading'); if(prayerHeading) prayerHeading.textContent = t.prayerHeading;
      const prayerMeta = document.querySelector('#prayerCard .prayer-meta'); if(prayerMeta) prayerMeta.textContent = t.prayerSub;
      const prayerBtn = document.querySelector('#prayerCard .prayer-btn'); if(prayerBtn) prayerBtn.textContent = t.prayerBtn;
      const contactHeading = document.querySelector('#contactCard #contactHeading'); if(contactHeading) contactHeading.textContent = t.contactHeading;
      const contactMetaTitle = document.querySelector('#contactCard .meta-title'); if(contactMetaTitle) contactMetaTitle.textContent = t.contactGetInTouch;
      const visitName = document.querySelector('#contactCard .visit-name'); if(visitName) visitName.textContent = t.visitUsName;
      const visitAddr = document.querySelector('#contactCard .visit-addr'); if(visitAddr) visitAddr.textContent = t.visitUsAddress;
      document.querySelectorAll('#contactCard .contact-btn').forEach(btn=>{
        if(btn.classList.contains('phone')) btn.textContent = t.contactCall;
        if(btn.classList.contains('email')) btn.textContent = t.contactEmail;
        if(btn.classList.contains('map')) btn.textContent = t.contactMap;
      });
    }

    // ---------- ANNOUNCEMENTS ----------
    let lastAnnouncementData = null;
    function isExpired(expireDateStr){ if(!expireDateStr) return false; const now = new Date(); const expire = new Date(expireDateStr + 'T23:59:59'); return now > expire; }

    function renderSingleAnnouncement(containerEl, data, lang){
      if(!containerEl) return;
      containerEl.innerHTML = '';
      const wrapper = document.createElement('div'); wrapper.className = 'announcement';
      const meta = document.createElement('div'); meta.className = 'meta-row';
      const dateSpan = document.createElement('div'); dateSpan.className = 'small-muted'; dateSpan.textContent = data.date || new Date().toLocaleDateString();
      const typeSpan = document.createElement('div'); typeSpan.className = 'small-muted'; typeSpan.textContent = (data.type || 'announcement').toUpperCase();
      meta.appendChild(dateSpan); meta.appendChild(typeSpan); wrapper.appendChild(meta);
      if(data.thumbnail){ const img = document.createElement('img'); img.className='thumb'; img.src=data.thumbnail; img.alt=data.title||'Announcement image'; wrapper.appendChild(img); }
      const title = document.createElement('h3'); title.className='announce-title'; const titleText = (lang==='fr' && data.title_fr) ? data.title_fr : data.title || ''; title.textContent = titleText; wrapper.appendChild(title);
      const descText = (lang==='fr' && data.description_fr) ? data.description_fr : data.description || '';
      if(descText){ const desc = document.createElement('div'); desc.className='announce-desc'; desc.textContent = descText; wrapper.appendChild(desc); }
      if(data.extra && (data.extra.location || data.extra.time)){ const info = document.createElement('div'); info.className='small-muted'; info.textContent = `${data.extra.location ? data.extra.location + ' • ' : ''}${data.extra.time ? data.extra.time : ''}`.trim(); wrapper.appendChild(info); }
      const ctaRow = document.createElement('div'); ctaRow.className='cta-row';
      const learn = document.createElement('a'); learn.className='btn btn-primary'; learn.href = data.learnMoreUrl || '#'; learn.target='_blank'; learn.rel='noopener'; learn.textContent = translations[getSavedLang()].learn_more || 'Learn more';
      ctaRow.appendChild(learn); wrapper.appendChild(ctaRow);
      containerEl.appendChild(wrapper);
    }

    function renderAnnouncementsFromData(rawData){
      lastAnnouncementData = rawData;
      const lang = getSavedLang();
      let items = [];
      if(!rawData) items = [];
      else if(Array.isArray(rawData)) items = rawData;
      else if(typeof rawData === 'object'){ if(Array.isArray(rawData.items)) items = rawData.items; }
      const active = (items||[]).filter(a => a.enabled !== false && !isExpired(a.expireDate));
      const primaryContainer = document.getElementById('announcementContainer');
      const secondaryContainer = document.getElementById('announcementContainer2');
      const tertiaryContainer = document.getElementById('announcementContainer3');
      if(primaryContainer) primaryContainer.innerHTML=''; if(secondaryContainer) secondaryContainer.innerHTML=''; if(tertiaryContainer) tertiaryContainer.innerHTML='';
      if(active[0] && primaryContainer) renderSingleAnnouncement(primaryContainer, active[0], lang);
      if(active[1] && secondaryContainer) renderSingleAnnouncement(secondaryContainer, active[1], lang);
      if(active[2] && tertiaryContainer) renderSingleAnnouncement(tertiaryContainer, active[2], lang);
      if(active.length===0 && primaryContainer){ const placeholder = document.createElement('div'); placeholder.className='announcement-placeholder'; placeholder.textContent = translations[lang].no_announcements; primaryContainer.appendChild(placeholder); }
      applyTranslations();
      loadNextEvent();
    }

    async function loadAndRenderAnnouncements(){
      const url = ANNOUNCEMENT_JSON_PATH + '?t=' + Date.now();
      try {
        const res = await fetch(url, { cache: 'no-store' });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        renderAnnouncementsFromData(data);
      } catch (err) {
        if(lastAnnouncementData){ renderAnnouncementsFromData(lastAnnouncementData); return; }
        renderAnnouncementsFromData({ items:[{ title:"Announcements temporarily unavailable", description:"We are updating announcements. Check back soon.", enabled:true }]});
      }
    }

    // ---------- SITE CONFIG (optional) ----------
    async function loadSiteConfig(){
      try {
        const res = await fetch(SITE_CONFIG_PATH, { cache: 'no-store' });
        if(!res.ok) return;
        const cfg = await res.json();
        if('showSecondAnnouncement' in cfg) window.SHOW_SECOND_ANNOUNCEMENT = cfg.showSecondAnnouncement;
        if('showThirdAnnouncement' in cfg) window.SHOW_THIRD_ANNOUNCEMENT = cfg.showThirdAnnouncement;
      } catch (e) { /* ignore */ }
    }

    // ---------- APP LINK HELPER ----------
    function tryOpenAppThenFallback(anchor, event){
      if (event.metaKey || event.ctrlKey || event.shiftKey || event.button === 1) return;
      const appHref = anchor.getAttribute('data-app-href');
      const webHref = anchor.href;
      const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      if(!isMobile || !appHref) return;
      event.preventDefault();
      let didHide = false;
      function onVisibilityChange() { didHide = document.hidden; }
      document.addEventListener('visibilitychange', onVisibilityChange);
      const timeout = setTimeout(() => {
        document.removeEventListener('visibilitychange', onVisibilityChange);
        if (!didHide) window.location = webHref;
      }, 1200);
      try { window.location = appHref; } catch (e) { clearTimeout(timeout); document.removeEventListener('visibilitychange', onVisibilityChange); window.location = webHref; }
    }

    function wireAppLinks(){
      document.querySelectorAll('.hub-button[data-app-href]').forEach(a=>{
        a.addEventListener('click', function(e){ tryOpenAppThenFallback(a, e); });
      });
    }

    // ---------- LEADERS ----------
    async function loadLeaders(){
      const grid = document.getElementById('leadersGrid');
      try {
        const res = await fetch('/leaders.json', { cache: 'no-store' });
        if(!res.ok) throw new Error('Failed to load leaders.json');
        const data = await res.json();
        const items = (data.items || []).filter(Boolean);
        if(!items.length){ grid.innerHTML = '<div class="small-muted">No leaders listed.</div>'; applyTranslations(); return; }
        grid.innerHTML = '';
        items.forEach(l => {
          const card = document.createElement('div'); card.className='leader-card';
          const img = document.createElement('img'); img.src = l.photo || '/step.png'; img.alt = l.name || 'Leader';
          const name = document.createElement('div'); name.style.fontWeight='700'; name.textContent = l.name || '';
          const role = document.createElement('div'); role.className='small-muted'; role.textContent = l.role || '';
          card.appendChild(img); card.appendChild(name); card.appendChild(role); grid.appendChild(card);
        });
        applyTranslations();
      } catch (e) { grid.innerHTML = '<div class="small-muted">Could not load leaders.</div>'; applyTranslations(); }
    }

    // ---------- EVENTS ----------
    async function loadNextEvent(){
      const container = document.getElementById('upcomingEventCard');
      if(!container) return;
      try {
        const res = await fetch('/events.json', { cache: 'no-store' });
        if(!res.ok){ container.innerHTML=''; applyTranslations(); return; }
        const data = await res.json();
        const items = (data.items || []).filter(e => e.public !== false);
        const now = new Date();
        const upcoming = items.map(e => ({...e, start: new Date(`${e.date}T${e.startTime || '00:00'}`)})).filter(e => e.start >= now).sort((a,b)=>a.start-b.start);
        if(!upcoming.length){ container.innerHTML=''; applyTranslations(); return; }
        const next = upcoming[0];
        container.innerHTML = `<div class="card" style="padding:12px;">
          <div style="font-weight:700;">Upcoming Event</div>
          <div class="small-muted" style="margin-top:6px;">${new Date(next.date).toLocaleDateString()} • ${next.startTime || ''}</div>
          <div style="margin-top:6px;font-weight:700;">${next.title || ''}</div>
          <div class="small-muted" style="margin-top:6px;">${next.location || ''}</div>
          <div class="cta-row" style="margin-top:10px;">
            <a class="btn btn-primary" href="${toGoogleCalendarUrl(next)}" target="_blank" rel="noopener">Add to Google</a>
            <button class="btn btn-ghost" onclick='downloadICS(${JSON.stringify(next).replace(/'/g,"\\'")})'>Add to Apple/Outlook</button>
          </div>
        </div>`;
        applyTranslations();
      } catch (e) { container.innerHTML=''; applyTranslations(); }
    }

    function toGoogleCalendarUrl(event){
      const start = `${event.date.replace(/-/g,'')}T${(event.startTime||'00:00').replace(':','')}00`;
      const end = event.endTime ? `${event.date.replace(/-/g,'')}T${event.endTime.replace(':','')}00` : `${event.date.replace(/-/g,'')}T${String(Number((event.startTime||'00:00').split(':')[0]) + 1).padStart(2,'0')}${(event.startTime||'00:00').split(':')[1]}00`;
      const params = new URLSearchParams({ action:'TEMPLATE', text:event.title||'', dates:`${start}/${end}`, details:event.description||'', location:event.location||'' });
      return `https://www.google.com/calendar/render?${params.toString()}`;
    }

    function downloadICS(event){
      const start = `${event.date.replace(/-/g,'')}T${(event.startTime||'00:00').replace(':','')}00`;
      const end = event.endTime ? `${event.date.replace(/-/g,'')}T${event.endTime.replace(':','')}00` : `${event.date.replace(/-/g,'')}T${String(Number((event.startTime||'00:00').split(':')[0]) + 1).padStart(2,'0')}${(event.startTime||'00:00').split(':')[1]}00`;
      const ics = `BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
UID:${event.id || 'event'}@cmrhub
DTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').split('.')[0]}Z
DTSTART:${start}
DTEND:${end}
SUMMARY:${event.title || ''}
DESCRIPTION:${(event.description||'').replace(/\n/g,' ')}
LOCATION:${event.location || ''}
END:VEVENT
END:VCALENDAR`;
      const blob = new Blob([ics], { type: 'text/calendar' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `${event.id || 'event'}.ics`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // ---------- CONTACT card ----------
    (function(){
      const CONTACT_PHONE = '+1-817-555-0123';
      const CONTACT_EMAIL = 'info@cmrestauration.org';
      const CONTACT_ADDRESS = '123 Church St, Fort Worth, TX';
      const MAP_QUERY = encodeURIComponent(CONTACT_ADDRESS);

      function createContactCard(){
        if(document.getElementById('contactCard')) return document.getElementById('contactCard');
        const card = document.createElement('div'); card.id='contactCard'; card.className='card contact-card';
        card.innerHTML = `
          <h3 id="contactHeading" style="margin:0 0 12px 0;">Contact</h3>
          <div class="contact-meta" style="margin-bottom:6px;">
            <div class="meta-title" style="font-weight:700;">Get in touch</div>
            <div class="visit-name" style="margin-top:4px;font-weight:700;">Christ Missionary Revival Church</div>
            <div class="visit-addr small-muted" style="margin-top:4px;">${CONTACT_ADDRESS}</div>
          </div>
          <div class="contact-row" role="group" aria-label="Contact actions">
            <a class="contact-btn phone" href="tel:${CONTACT_PHONE.replace(/\s+/g,'')}" aria-label="Call ${CONTACT_PHONE}">Call</a>
            <a class="contact-btn email" href="mailto:${CONTACT_EMAIL}" aria-label="Email ${CONTACT_EMAIL}">Email</a>
            <a class="contact-btn map" href="https://www.google.com/maps/search/?api=1&query=${MAP_QUERY}" target="_blank" rel="noopener" aria-label="Open map">Map</a>
          </div>`;
        document.body.appendChild(card);
        return card;
      }

      window.createContactCard = createContactCard;
    })();

    // ---------- PRAYER card ----------
    (function(){
      const PRAYER_EMAIL = 'info@cmrestauration.org';
      const PRAYER_SUBJECT = encodeURIComponent('Prayer Request');
      const PRAYER_BODY = encodeURIComponent('Prayer Request');

      function createPrayerCard(){
        if(document.getElementById('prayerCard')) return document.getElementById('prayerCard');
        const card = document.createElement('div'); card.id='prayerCard'; card.className='card prayer-card';
        card.innerHTML = `
          <h3 id="prayerHeading" style="margin:0 0 12px 0;">Prayer Request</h3>
          <div class="prayer-meta" style="margin-bottom:6px;">Share a request and we will pray for you</div>
          <div><a class="btn btn-primary prayer-btn" href="mailto:${PRAYER_EMAIL}?subject=${PRAYER_SUBJECT}&body=${PRAYER_BODY}" aria-label="Request Prayer">Request Prayer</a></div>`;
        document.body.appendChild(card);
        return card;
      }

      window.createPrayerCard = createPrayerCard;
    })();

    // ---------- enforce mobile order strictly ----------
    function enforceMobileOrder(){
      const desktop = window.innerWidth >= 981;
      const left = document.getElementById('leftColumn');
      const right = document.getElementById('rightColumn');
      const hub = document.getElementById('hubCard');
      const latest = document.getElementById('latestSermonCard');
      const bible = document.getElementById('biblePlanCard');
      const announcements = document.getElementById('announcementsCardPrimary');
      const upcoming = document.getElementById('upcomingEventCard');
      const leaders = document.getElementById('leadersSection');
      const serviceTimes = document.getElementById('serviceTimes');
      const contactCard = window.createContactCard ? window.createContactCard() : document.getElementById('contactCard');
      const prayerCard = window.createPrayerCard ? window.createPrayerCard() : document.getElementById('prayerCard');

      if(!left || !right) return;

      if(!desktop){
        // Mobile strict order:
        // Hub, Latest Sermon, Bible, Announcements, Upcoming, Leaders, Prayer, Service Times, Contact
        const order = [hub, latest, bible, announcements, upcoming, leaders, prayerCard, serviceTimes, contactCard];
        order.forEach(el => { if(el) left.appendChild(el); });
      } else {
        // Desktop:
        // Left: Hub, Latest Sermon, Bible, Leaders, Contact
        // Right: Announcements, More Announcements, Upcoming, Service Times, Prayer
        // Left column
        [hub, latest, bible, leaders].forEach(el => { if(el) left.appendChild(el); });
        if(contactCard && leaders) {
          if(leaders.parentElement) leaders.parentElement.insertBefore(contactCard, leaders.nextSibling);
        } else if(contactCard) left.appendChild(contactCard);
        // Right column
        if(announcements) right.appendChild(announcements);
        const ann2 = document.getElementById('announcementsCard2'); if(ann2) right.appendChild(ann2);
        if(upcoming) right.appendChild(upcoming);
        if(serviceTimes) right.appendChild(serviceTimes);
        if(prayerCard && serviceTimes) serviceTimes.parentElement.insertBefore(prayerCard, serviceTimes.nextSibling);
      }
      applyTranslations();
    }

    // ---------- Sermon loader (thumbnail-first) ----------
    async function loadSingleLatestSermon(){
      const wrap = document.getElementById('sermonVideoWrap');
      const titleEl = document.getElementById('sermonTitle');
      const detailsEl = document.getElementById('sermonDetails');
      const openBtn = document.getElementById('openSermonOnYT');
      const shareBtn = document.getElementById('shareSermonBtn');
      const copyBtn = document.getElementById('copySermonLinkBtn');

      try {
        const res = await fetch('/sermons.json', { cache: 'no-store' });
        if(!res.ok) throw new Error('Failed to load sermons.json');
        const data = await res.json();
        const items = (data.items || []).filter(i => i.videoId && i.date);
        if(!items.length) throw new Error('No sermons found');
        items.sort((a,b)=> new Date(b.date) - new Date(a.date));
        const latest = items[0];

        titleEl.textContent = latest.title || 'Latest Sermon';
        const dateStr = latest.date ? new Date(latest.date).toLocaleDateString() : '';
        detailsEl.textContent = `${latest.preacher || ''}${latest.preacher ? ' • ' : ''}${dateStr}`;
        const videoUrl = `https://www.youtube.com/watch?v=${latest.videoId}`;
        openBtn.href = videoUrl;

        shareBtn.onclick = async () => {
          const shareData = { title: latest.title, text: latest.title, url: videoUrl };
          if (navigator.share) { try { await navigator.share(shareData); return; } catch (e) {} }
          const fb = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(videoUrl)}`;
          window.open(fb, '_blank', 'noopener');
        };

        copyBtn.onclick = async () => {
          try { await navigator.clipboard.writeText(videoUrl); copyBtn.textContent = 'Copied'; setTimeout(()=>copyBtn.textContent='Copy link',1600); } catch (e) { prompt('Copy this link', videoUrl); }
        };

        if(latest.thumbnail){
          wrap.innerHTML = '';
          const thumbWrap = document.createElement('div'); thumbWrap.className='video-thumb'; thumbWrap.style.width='100%'; thumbWrap.style.height='100%';
          const img = document.createElement('img'); img.src = latest.thumbnail; img.alt = latest.title || 'Sermon thumbnail';
          thumbWrap.appendChild(img);
          const overlay = document.createElement('div'); overlay.className='play-overlay';
          const play = document.createElement('div'); play.className='play-button'; play.innerHTML='&#9658;';
          overlay.appendChild(play); thumbWrap.appendChild(overlay);
          thumbWrap.addEventListener('click', () => {
            const iframe = document.createElement('iframe');
            iframe.src = `https://www.youtube.com/embed/${latest.videoId}?rel=0&modestbranding=1`;
            iframe.title = latest.title || 'Latest sermon';
            iframe.loading = 'lazy';
            iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
            iframe.style.width='100%'; iframe.style.height='100%'; iframe.style.border='0';
            wrap.innerHTML=''; wrap.appendChild(iframe);
          }, { once:true });
          wrap.appendChild(thumbWrap);
        } else {
          wrap.innerHTML = '';
          const iframe = document.createElement('iframe');
          iframe.src = `https://www.youtube.com/embed/${latest.videoId}?rel=0&modestbranding=1`;
          iframe.title = latest.title || 'Latest sermon';
          iframe.loading = 'lazy';
          iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
          iframe.style.width='100%'; iframe.style.height='100%'; iframe.style.border='0';
          wrap.appendChild(iframe);
        }
        applyTranslations();
      } catch (err) {
        console.error(err);
        if(wrap) wrap.innerHTML = '<div style="padding:18px;color:#fff">Latest sermon unavailable</div>';
        if(titleEl) titleEl.textContent = 'Latest sermon unavailable';
        if(detailsEl) detailsEl.textContent = '';
        applyTranslations();
      }
    }

    // ---------- Resize handling ----------
    let _placementTimer = null;
    window.addEventListener('resize', () => {
      clearTimeout(_placementTimer);
      _placementTimer = setTimeout(() => { enforceMobileOrder(); }, 120);
    });

    // ---------- Init ----------
    document.addEventListener('DOMContentLoaded', async () => {
      buildLangSwitcher();
      applyTranslations();
      wireAppLinks();

      // create contact & prayer elements so they can be moved
      if(window.createContactCard) window.createContactCard();
      if(window.createPrayerCard) window.createPrayerCard();

      await loadSiteConfig();
      loadAndRenderAnnouncements();
      setInterval(loadAndRenderAnnouncements, 5 * 60 * 1000);

      loadLeaders();
      loadSingleLatestSermon();
      loadNextEvent();

      // enforce mobile order immediately and shortly after to ensure DOM ready
      enforceMobileOrder();
      setTimeout(enforceMobileOrder, 160);

      // Bible plan share wiring
      const planUrl = 'https://bibleinayearonline.com/chronological-bible-custom-reading-plan/';
      const shareBtn = document.getElementById('shareTodayBtn');
      const status = document.getElementById('biblePlanStatus');
      if(shareBtn){
        shareBtn.addEventListener('click', async () => {
          try {
            if(navigator.share){ await navigator.share({ title:'CMR — Bible in a Year', text:'Read today’s chronological Bible in a Year reading from CMR Hub', url:planUrl }); status.textContent='Shared'; setTimeout(()=>status.textContent='',1600); return; }
            if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(planUrl); status.textContent='Link copied'; setTimeout(()=>status.textContent='',1600); return; }
            window.prompt('Copy this link to share', planUrl);
          } catch (e) { try{ await navigator.clipboard.writeText(planUrl); status.textContent='Link copied'; setTimeout(()=>status.textContent='',1600);}catch(e){ window.prompt('Copy this link to share', planUrl); } }
        });
      }
    });
  </script>
</body>
</html>
