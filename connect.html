<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <link rel="icon" type="image/png" sizes="512x512" href="/cmr512.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/cmr192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/cmr180.png">
  <title>Connect — CMR</title>

  <style>
    :root{
      --accent:#2b6cb0;
      --muted:#6b7280;
      --card-bg:#ffffff;
      --page-bg:#f3f4f6;
      --radius:12px;
      --max-width:900px;
      --pad:20px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }

    html,body{ margin:0; padding:0; background:var(--page-bg); color:#0f172a; -webkit-font-smoothing:antialiased; }
    .wrap{ width:100%; max-width:var(--max-width); margin:28px auto; padding:var(--pad); box-sizing:border-box; }
    .card{ background:linear-gradient(180deg,#fff,#fbfbfb); border-radius:var(--radius); padding:22px; box-shadow:0 8px 30px rgba(15,23,42,0.06); border:1px solid rgba(15,23,42,0.04); }
    .header{ display:flex; gap:14px; align-items:flex-start; margin-bottom:12px; }
    .logo-stack { display:flex; flex-direction:column; align-items:center; gap:8px; flex:0 0 120px; }
    .logo{ width:120px; height:120px; border-radius:12px; background:#ffffff; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .logo img{ width:100%; height:100%; object-fit:contain; display:block; }
    .title-block{ display:flex; flex-direction:column; gap:6px; align-items:flex-start; }
    .intro-text { font-size:14px; color:var(--muted); text-align:center; max-width:220px; }
    h1{ margin:0; font-size:20px; font-weight:800; color:#0f172a; text-transform:none; text-align:center; }
    .subtitle{ margin:0; color:var(--muted); font-size:14px; }

    form { margin-top:14px; display:grid; gap:12px; }
    .row { display:flex; gap:12px; }
    .col { flex:1; display:flex; flex-direction:column; gap:6px; }
    label { font-weight:700; font-size:13px; color:#0f172a; }
    input[type="text"], input[type="tel"], input[type="email"], textarea, select, input[type="number"] {
      padding:10px 12px; border-radius:10px; border:1px solid rgba(15,23,42,0.06); background:#fff; font-size:14px; color:#0f172a;
      box-sizing:border-box;
    }
    textarea { min-height:220px; resize:vertical; width:100%; }
    .large-textarea { min-height:260px; font-size:15px; padding:14px; }

    .small-muted{ font-size:13px; color:var(--muted); }

    .group { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .checkbox, .radio { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; background:#fff; border:1px solid rgba(15,23,42,0.04); cursor:pointer; }
    .checkbox input, .radio input { margin:0; }

    .actions { display:flex; gap:12px; align-items:center; margin-top:6px; }
    .btn { background:var(--accent); color:#fff; padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:800; text-decoration:none; display:inline-flex; align-items:center; gap:8px; }
    .btn-ghost { background:#fff; border:1px solid rgba(15,23,42,0.06); color:#0f172a; padding:10px 12px; border-radius:10px; cursor:pointer; }

    .field-error { color:#b91c1c; font-size:13px; display:none; margin-top:6px; }

    .thankyou {
      display:none;
      margin-top:12px;
      padding:14px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(43,108,176,0.08), rgba(43,108,176,0.04));
      border:1px solid rgba(43,108,176,0.12);
      color:#0f172a;
      font-weight:700;
    }

    .lang-switcher { position:fixed; top:12px; right:12px; display:flex; gap:8px; z-index:9999; }
    .lang-btn { padding:8px 10px; border-radius:8px; border:1px solid rgba(15,23,42,0.06); background:#fff; cursor:pointer; font-weight:700; }

    .address-row { display:flex; gap:8px; align-items:center; position:relative; }
    .suggestions { position:absolute; top:44px; left:0; right:0; background:#fff; border:1px solid rgba(15,23,42,0.08); border-radius:8px; max-height:220px; overflow:auto; z-index:40; box-shadow:0 8px 20px rgba(15,23,42,0.06); }
    .suggestion-item { padding:8px 10px; cursor:pointer; border-bottom:1px solid rgba(15,23,42,0.03); }
    .suggestion-item:last-child { border-bottom:0; }
    .suggestion-item:hover { background:rgba(43,108,176,0.04); }

    .kids-block { margin-top:8px; padding:10px; border-radius:10px; background:linear-gradient(180deg,#fff,#fbfbfb); border:1px solid rgba(15,23,42,0.04); }
    .kid-row { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .kid-row input[type="text"], .kid-row input[type="number"], .kid-row select { padding:8px 10px; }

    @media (max-width:640px){
      .row { flex-direction:column; }
      .logo{ width:96px; height:96px; }
      .logo-stack { flex:0 0 auto; }
    }
  </style>
</head>
<body>
  <div class="lang-switcher" id="langSwitcherConnect" aria-hidden="false"></div>

  <div class="wrap">
    <div class="card" role="main" aria-labelledby="connectHeading">
      <div class="header">
        <div class="logo-stack" aria-hidden="false">
          <div class="logo">
            <img src="/cmr180.png" alt="CMR logo" id="connectLogo">
          </div>

          <!-- Intro text below logo -->
          <div class="title-block" style="align-items:center;">
            <div class="intro-text" id="connectIntro">Tell us about yourself and how you'd like to get involved.</div>
            <!-- Title below intro -->
            <h1 id="connectHeading">Connect</h1>
          </div>
        </div>

        <div style="flex:1;">
          <!-- optional right-side content left empty to keep layout balanced -->
        </div>
      </div>

      <form id="connectForm" name="connect" method="POST" data-netlify="true" netlify-honeypot="bot-field" novalidate>
        <input type="hidden" name="form-name" value="connect" />

        <div class="row">
          <div class="col">
            <label for="first" id="labelFirst">First name</label>
            <input id="first" name="first" type="text" required aria-required="true" />
            <div class="field-error" id="first-error" aria-hidden="true"></div>
          </div>

          <div class="col">
            <label for="last" id="labelLast">Last name</label>
            <input id="last" name="last" type="text" required aria-required="true" />
            <div class="field-error" id="last-error" aria-hidden="true"></div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="phone" id="labelPhone">Phone</label>
            <input id="phone" name="phone" type="tel" required aria-required="true" />
            <div class="field-error" id="phone-error" aria-hidden="true"></div>
          </div>

          <div class="col">
            <label for="email" id="labelEmail">Email (optional)</label>
            <input id="email" name="email" type="email" />
            <div class="field-error" id="email-error" aria-hidden="true"></div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="address" id="labelAddress">Address (optional)</label>
            <div class="address-row">
              <input id="address" name="address" type="text" placeholder="Start typing address..." aria-describedby="addressHelp" autocomplete="off" />
              <input id="apt" name="apt" type="text" placeholder="Apt / Bldg" style="width:140px;" />
              <div class="suggestions" id="addressSuggestions" style="display:none;"></div>
            </div>
            <div id="addressHelp" class="small-muted">Select an address to auto-fill city, state and ZIP.</div>
          </div>

          <div class="col">
            <label for="status" id="labelStatus">Status</label>
            <select id="status" name="status" aria-describedby="statusHelp"></select>
            <div id="statusHelp" class="small-muted">Choose the option that best describes you.</div>

            <div style="margin-top:10px;">
              <label id="labelGender">Gender</label>
              <div class="group" role="radiogroup" aria-labelledby="labelGender" style="margin-top:8px;">
                <label class="radio"><input type="radio" name="gender" value="F" checked> <span id="genderF">F</span></label>
                <label class="radio"><input type="radio" name="gender" value="M"> <span id="genderM">M</span></label>
              </div>
            </div>
          </div>
        </div>

        <div>
          <label id="labelInterest">I'd like to learn</label>
          <div class="group" role="group" aria-labelledby="labelInterest">
            <label class="checkbox"><input type="checkbox" name="interest" value="baptism"> <span class="interestText" data-key="baptism">Baptism</span></label>
            <label class="checkbox"><input type="checkbox" name="interest" value="serve"> <span class="interestText" data-key="serve">Serving</span></label>
            <label class="checkbox"><input type="checkbox" name="interest" value="learn"> <span class="interestText" data-key="learn">Learn about CMR</span></label>
            <label class="checkbox"><input type="checkbox" name="interest" value="follow"> <span class="interestText" data-key="follow">Talk about following Jesus</span></label>
            <label class="checkbox"><input type="checkbox" name="interest" value="other"> <span class="interestText" data-key="other">Giving</span></label>
          </div>
        </div>

        <div style="margin-top:12px;">
          <label id="labelKids">Do you have kids?</label>
          <div class="group" role="radiogroup" aria-labelledby="labelKids" style="margin-top:8px;">
            <label class="radio"><input type="radio" name="hasKids" value="no" checked> <span id="kidsNoLabel">No</span></label>
            <label class="radio"><input type="radio" name="hasKids" value="yes"> <span id="kidsYesLabel">Yes</span></label>
          </div>

          <div id="kidsContainer" class="kids-block" style="display:none;">
            <div id="kidsList"></div>
            <div style="margin-top:8px;">
              <button type="button" class="btn-ghost" id="addKidBtn">Add child</button>
              <button type="button" class="btn-ghost" id="removeKidBtn" style="display:none;">Remove child</button>
            </div>
            <div class="small-muted" style="margin-top:8px;" id="kidsHint">You can add up to 2 children.</div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <label id="labelPrayerSubtle" style="font-weight:600; color:var(--muted);">Prayer Request</label>
          <textarea id="prayer" name="prayer" class="large-textarea" placeholder="Share your request here"></textarea>
        </div>

        <div class="actions">
          <button type="submit" class="btn" id="submitBtn">Submit</button>
          <button type="reset" class="btn-ghost" id="resetBtn">Reset</button>
        </div>

        <div class="thankyou" id="thankyou" role="status" aria-live="polite">
          Thank you — we received your submission and will get back to you soon.
        </div>
      </form>
    </div>
  </div>

  <script>
    // Translations (English + French) - every visible string included
    const T = {
      en: {
        connectIntro: "Tell us about yourself and how you'd like to get involved.",
        connectHeading: "Connect",
        labelFirst: "First name",
        labelLast: "Last name",
        labelPhone: "Phone",
        labelEmail: "Email (optional)",
        labelAddress: "Address (optional)",
        addressPlaceholder: "Start typing address...",
        addressHelp: "Select an address to auto-fill city, state and ZIP.",
        labelStatus: "Status",
        statusHelp: "Choose the option that best describes you.",
        statusOptions: { first_visit: "First visit", second_visit: "Second visit", regular: "Regular attendee", member: "Member" },
        labelGender: "Gender",
        genderF: "F",
        genderM: "M",
        labelInterest: "I'd like to learn",
        interestOptions: { baptism: "Baptism", serve: "Serving", learn: "Learn about CMR", follow: "Talk about following Jesus", other: "Giving" },
        labelKids: "Do you have kids?",
        kidsYesLabel: "Yes",
        kidsNoLabel: "No",
        addKidBtn: "Add child",
        removeKidBtn: "Remove child",
        kidsHint: "You can add up to 2 children.",
        kidNamePlaceholder: "Name",
        kidAgePlaceholder: "Age",
        kidSexLabel: "Sex",
        prayerSubtle: "Prayer Request",
        prayerPlaceholder: "Share your request here",
        submitBtn: "Submit",
        resetBtn: "Reset",
        thankYou: "Thank you — we received your submission and will get back to you soon.",
        validation: {
          required: "This field is required.",
          phoneInvalid: "Enter a valid phone number.",
          emailInvalid: "Enter a valid email address."
        }
      },
      fr: {
        connectIntro: "Parlez-nous de vous et comment vous souhaitez vous impliquer.",
        connectHeading: "Connect",
        labelFirst: "Prénom",
        labelLast: "Nom",
        labelPhone: "Téléphone",
        labelEmail: "E-mail (optionnel)",
        labelAddress: "Adresse (optionnel)",
        addressPlaceholder: "Commencez à taper l'adresse...",
        addressHelp: "Sélectionnez une adresse pour remplir automatiquement la ville, l'état et le code postal.",
        labelStatus: "Statut",
        statusHelp: "Choisissez l'option qui vous décrit le mieux.",
        statusOptions: { first_visit: "Première visite", second_visit: "Deuxième visite", regular: "Participant régulier", member: "Membre" },
        labelGender: "Genre",
        genderF: "F",
        genderM: "M",
        labelInterest: "Je suis intéressé par",
        interestOptions: { baptism: "Baptême", serve: "Servir", learn: "En savoir plus sur CMR", follow: "Parler de suivre Jésus", other: "Donner" },
        labelKids: "Avez-vous des enfants ?",
        kidsYesLabel: "Oui",
        kidsNoLabel: "Non",
        addKidBtn: "Ajouter un enfant",
        removeKidBtn: "Supprimer l'enfant",
        kidsHint: "Vous pouvez ajouter jusqu'à 2 enfants.",
        kidNamePlaceholder: "Nom",
        kidAgePlaceholder: "Âge",
        kidSexLabel: "Sexe",
        prayerSubtle: "Demande de prière",
        prayerPlaceholder: "Partagez votre demande ici",
        submitBtn: "Soumettre",
        resetBtn: "Réinitialiser",
        thankYou: "Merci — nous avons reçu votre message et nous vous contacterons bientôt.",
        validation: {
          required: "Ce champ est requis.",
          phoneInvalid: "Entrez un numéro de téléphone valide.",
          emailInvalid: "Entrez une adresse e-mail valide."
        }
      }
    };

    function getSavedLang(){ return localStorage.getItem('cmr_lang') || 'en'; }
    function setSavedLang(lang){ localStorage.setItem('cmr_lang', lang); applyTranslations(); }

    // Build language switcher
    function buildLangSwitcher(){
      const container = document.getElementById('langSwitcherConnect');
      if(!container) return;
      container.innerHTML = '';
      const enBtn = document.createElement('button'); enBtn.className='lang-btn'; enBtn.textContent='EN'; enBtn.onclick = ()=> setSavedLang('en');
      const frBtn = document.createElement('button'); frBtn.className='lang-btn'; frBtn.textContent='FR'; frBtn.onclick = ()=> setSavedLang('fr');
      container.appendChild(enBtn); container.appendChild(frBtn);
    }

    // Apply translations to all elements (force translate everything)
    function applyTranslations(){
      const lang = getSavedLang();
      const t = T[lang] || T.en;

      const setText = (id, value) => {
        const el = document.getElementById(id);
        if(!el || typeof value !== 'string') return;
        el.textContent = value;
      };

      // header
      setText('connectIntro', t.connectIntro);
      setText('connectHeading', t.connectHeading);

      // basic labels
      setText('labelFirst', t.labelFirst);
      setText('labelLast', t.labelLast);
      setText('labelPhone', t.labelPhone);
      setText('labelEmail', t.labelEmail);
      setText('labelAddress', t.labelAddress);
      const addr = document.getElementById('address');
      if(addr) addr.placeholder = t.addressPlaceholder || '';
      setText('addressHelp', t.addressHelp);

      // status
      setText('labelStatus', t.labelStatus);
      setText('statusHelp', t.statusHelp);
      const sel = document.getElementById('status');
      if(sel){
        sel.innerHTML = '';
        for(const key of ['first_visit','second_visit','regular','member']){
          const o = document.createElement('option');
          o.value = key;
          o.textContent = (t.statusOptions && t.statusOptions[key]) || key;
          sel.appendChild(o);
        }
      }

      // gender
      setText('labelGender', t.labelGender);
      setText('genderF', t.genderF);
      setText('genderM', t.genderM);

      // interest checkboxes
      setText('labelInterest', t.labelInterest);
      document.querySelectorAll('.interestText').forEach(el => {
        const key = el.getAttribute('data-key');
        el.textContent = (t.interestOptions && t.interestOptions[key]) || key;
      });

      // kids
      setText('labelKids', t.labelKids);
      setText('kidsYesLabel', t.kidsYesLabel);
      setText('kidsNoLabel', t.kidsNoLabel);
      setText('addKidBtn', t.addKidBtn);
      setText('removeKidBtn', t.removeKidBtn);
      setText('kidsHint', t.kidsHint);

      // prayer
      setText('labelPrayerSubtle', t.prayerSubtle);
      const prayer = document.getElementById('prayer');
      if(prayer) prayer.placeholder = t.prayerPlaceholder || '';

      // buttons and thank you
      setText('submitBtn', t.submitBtn);
      setText('resetBtn', t.resetBtn);
      setText('thankyou', t.thankYou);

      // kids placeholders if any exist
      document.querySelectorAll('#kidsList .kid-row').forEach((r) => {
        const name = r.querySelector('input[type="text"]');
        const age = r.querySelector('input[type="number"]');
        const sex = r.querySelector('select');
        if(name) name.placeholder = t.kidNamePlaceholder || '';
        if(age) age.placeholder = t.kidAgePlaceholder || '';
        if(sex){
          sex.innerHTML = '';
          const optM = document.createElement('option'); optM.value='M'; optM.textContent = t.genderM || 'M';
          const optF = document.createElement('option'); optF.value='F'; optF.textContent = t.genderF || 'F';
          sex.appendChild(optM); sex.appendChild(optF);
        }
      });
    }

    // Validation helpers
    function showError(el, message){
      const err = document.getElementById(el.id + '-error');
      if(err){ err.textContent = message; err.style.display = 'block'; err.setAttribute('aria-hidden','false'); el.classList.add('input-invalid'); }
    }
    function clearError(el){
      const err = document.getElementById(el.id + '-error');
      if(err){ err.textContent = ''; err.style.display = 'none'; err.setAttribute('aria-hidden','true'); el.classList.remove('input-invalid'); }
    }

    function validateField(input){
      const lang = getSavedLang();
      const v = T[lang].validation;
      if(!input) return true;
      const val = (input.value || '').trim();
      if(input.required && val === ''){
        showError(input, v.required);
        return false;
      }
      if(input.type === 'tel' && val !== ''){
        const phonePattern = /^[0-9+\-\s().]{7,20}$/;
        if(!phonePattern.test(val)){ showError(input, v.phoneInvalid); return false; }
      }
      if(input.type === 'email' && val !== ''){
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if(!emailPattern.test(val)){ showError(input, v.emailInvalid); return false; }
      }
      clearError(input);
      return true;
    }

    // Address autocomplete using Nominatim with suggestion dropdown
    let addressTimer = null;
    async function fetchAddressSuggestions(q){
      if(!q) return [];
  const viewbox = '-124.848974,49.384358,-66.885444,24.396308'; // left, top, right, bottom (use appropriate order for your endpoint)
const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&addressdetails=1&limit=6&viewbox=${viewbox}&bounded=1`;

      try {
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if(!res.ok) return [];
        const data = await res.json();
        return data;
      } catch (err) {
        console.warn('Address lookup failed', err);
        return [];
      }
    }

    function renderSuggestions(items){
      const box = document.getElementById('addressSuggestions');
      box.innerHTML = '';
      if(!items || items.length === 0){ box.style.display = 'none'; return; }
      items.forEach(it => {
        const div = document.createElement('div');
        div.className = 'suggestion-item';
        div.textContent = it.display_name;
        div.dataset.raw = JSON.stringify(it);
        div.addEventListener('click', () => {
          selectAddressItem(it);
        });
        box.appendChild(div);
      });
      box.style.display = 'block';
    }

    function selectAddressItem(item){
      const addrInput = document.getElementById('address');
      const aptInput = document.getElementById('apt');
      addrInput.value = item.display_name;
      // parse address details for city/state/postcode
      const ad = item.address || {};
      // create hidden fields or visible fields for city/state/postcode
      // We'll append or set values to inputs with ids city, state, zip if present, otherwise create them
      setOrCreateField('city', ad.city || ad.town || ad.village || ad.county || '');
      setOrCreateField('state', ad.state || ad.region || '');
      setOrCreateField('zip', ad.postcode || '');
      // keep apt input for user to fill
      document.getElementById('addressSuggestions').style.display = 'none';
    }

    function setOrCreateField(id, value){
      let el = document.getElementById(id);
      if(!el){
        // create a hidden input appended to the form
        el = document.createElement('input');
        el.type = 'hidden';
        el.id = id;
        el.name = id;
        document.getElementById('connectForm').appendChild(el);
      }
      el.value = value || '';
    }

    // Kids UI helpers (max 2)
    function createKidRow(index){
      const row = document.createElement('div');
      row.className = 'kid-row';
      row.dataset.index = index;

      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.name = `kid_name_${index}`;
      nameInput.placeholder = T[getSavedLang()].kidNamePlaceholder || 'Name';
      nameInput.style.flex = '1';

      const ageInput = document.createElement('input');
      ageInput.type = 'number';
      ageInput.name = `kid_age_${index}`;
      ageInput.placeholder = T[getSavedLang()].kidAgePlaceholder || 'Age';
      ageInput.min = 0;
      ageInput.max = 25;
      ageInput.style.width = '90px';

      const sexSelect = document.createElement('select');
      sexSelect.name = `kid_sex_${index}`;
      sexSelect.style.width = '90px';
      const optM = document.createElement('option'); optM.value='M'; optM.textContent = T[getSavedLang()].genderM || 'M';
      const optF = document.createElement('option'); optF.value='F'; optF.textContent = T[getSavedLang()].genderF || 'F';
      sexSelect.appendChild(optM); sexSelect.appendChild(optF);

      row.appendChild(nameInput);
      row.appendChild(ageInput);
      row.appendChild(sexSelect);
      return row;
    }

    function updateKidsPlaceholders(){
      const lang = getSavedLang();
      document.querySelectorAll('#kidsList .kid-row').forEach(r => {
        const name = r.querySelector('input[type="text"]');
        const age = r.querySelector('input[type="number"]');
        const sex = r.querySelector('select');
        if(name) name.placeholder = T[lang].kidNamePlaceholder || '';
        if(age) age.placeholder = T[lang].kidAgePlaceholder || '';
        if(sex){
          sex.innerHTML = '';
          const optM = document.createElement('option'); optM.value='M'; optM.textContent = T[lang].genderM || 'M';
          const optF = document.createElement('option'); optF.value='F'; optF.textContent = T[lang].genderF || 'F';
          sex.appendChild(optM); sex.appendChild(optF);
        }
      });
    }

    // Wire up DOM and events
    document.addEventListener('DOMContentLoaded', function(){
      buildLangSwitcher();
      applyTranslations();

      const form = document.getElementById('connectForm');
      if(!form) return;

      const first = document.getElementById('first');
      const last = document.getElementById('last');
      const phone = document.getElementById('phone');
      const email = document.getElementById('email');

      [first,last,phone,email].forEach(f => { if(!f) return; f.addEventListener('input', ()=> validateField(f)); f.addEventListener('blur', ()=> validateField(f)); });

      // Address autocomplete wiring
      const addressInput = document.getElementById('address');
      const suggestionsBox = document.getElementById('addressSuggestions');

      addressInput.addEventListener('input', () => {
        const q = addressInput.value.trim();
        if(addressTimer) clearTimeout(addressTimer);
        if(!q){ suggestionsBox.style.display = 'none'; return; }
        addressTimer = setTimeout(async () => {
          const items = await fetchAddressSuggestions(q);
          renderSuggestions(items);
        }, 300);
      });

      // close suggestions when clicking outside
      document.addEventListener('click', (e) => {
        if(!document.querySelector('.address-row')?.contains(e.target)) {
          suggestionsBox.style.display = 'none';
        }
      });

      // Kids handling
      const kidsRadios = Array.from(document.querySelectorAll('input[name="hasKids"]'));
      const kidsContainer = document.getElementById('kidsContainer');
      const kidsList = document.getElementById('kidsList');
      const addKidBtn = document.getElementById('addKidBtn');
      const removeKidBtn = document.getElementById('removeKidBtn');

      function setKidsVisibility(){
        const val = document.querySelector('input[name="hasKids"]:checked').value;
        if(val === 'yes'){ kidsContainer.style.display = 'block'; } else { kidsContainer.style.display = 'none'; }
      }
      kidsRadios.forEach(r => r.addEventListener('change', setKidsVisibility));
      setKidsVisibility();

      function kidCount(){ return kidsList.querySelectorAll('.kid-row').length; }

      addKidBtn.addEventListener('click', () => {
        if(kidCount() >= 2) return;
        const idx = kidCount() + 1;
        kidsList.appendChild(createKidRow(idx));
        if(kidCount() >= 1) removeKidBtn.style.display = 'inline-flex';
        if(kidCount() >= 2) addKidBtn.style.display = 'none';
        updateKidsPlaceholders();
      });

      removeKidBtn.addEventListener('click', () => {
        const rows = kidsList.querySelectorAll('.kid-row');
        if(rows.length === 0) return;
        rows[rows.length - 1].remove();
        if(kidCount() < 2) addKidBtn.style.display = 'inline-flex';
        if(kidCount() === 0) removeKidBtn.style.display = 'none';
      });

      // Submit handler
      form.addEventListener('submit', async function(e){
        e.preventDefault();
        // validate required fields
        let ok = true;
        [first,last,phone].forEach(f => { if(f) ok = validateField(f) && ok; });
        if(!ok){
          const firstInvalid = form.querySelector('.input-invalid');
          if(firstInvalid) firstInvalid.focus();
          return;
        }

        // collect form data
        const fd = new FormData(form);
        // interests
        const interests = Array.from(form.querySelectorAll('input[name="interest"]:checked')).map(i => i.value);
        fd.delete('interest');
        interests.forEach(i => fd.append('interest', i));

        // kids
        if(document.querySelector('input[name="hasKids"]:checked')?.value === 'yes'){
          const kids = Array.from(kidsList.querySelectorAll('.kid-row')).map((r, idx) => {
            const name = r.querySelector('input[type="text"]')?.value || '';
            const age = r.querySelector('input[type="number"]')?.value || '';
            const sex = r.querySelector('select')?.value || '';
            return { name, age, sex };
          });
          kids.forEach((k, i) => {
            fd.append(`kid_name_${i+1}`, k.name);
            fd.append(`kid_age_${i+1}`, k.age);
            fd.append(`kid_sex_${i+1}`, k.sex);
          });
        }

        // show thank you
        const thank = document.getElementById('thankyou');
        thank.style.display = 'block';
        thank.setAttribute('aria-hidden','false');

        // attempt to POST to Netlify (best-effort)
        try {
          await fetch('/', { method: 'POST', body: fd, headers: { 'Accept': 'application/json' } });
        } catch (err) {
          console.warn('Netlify submit failed (non-blocking):', err);
        }

        // reset UI
        form.reset();
        kidsList.innerHTML = '';
        removeKidBtn.style.display = 'none';
        addKidBtn.style.display = 'inline-flex';
        setKidsVisibility();
        [first,last,phone,email].forEach(f => { if(f) clearError(f); });

        setTimeout(()=>{ thank.style.display = 'none'; thank.setAttribute('aria-hidden','true'); }, 8000);
      });

      // Reset handler
      const resetBtn = document.getElementById('resetBtn');
      resetBtn.addEventListener('click', () => {
        document.getElementById('kidsList').innerHTML = '';
        document.querySelectorAll('#city,#state,#zip').forEach(el => { if(el) el.value = ''; });
        [first,last,phone,email].forEach(f => { if(f) clearError(f); });
        setTimeout(() => applyTranslations(), 40);
      });

      // Reapply translations on storage change
      window.addEventListener('storage', (e) => {
        if(e.key === 'cmr_lang') applyTranslations();
      });

      // Ensure placeholders and dynamic labels reflect language
      updateKidsPlaceholders();
    });
  </script>
</body>
</html>
