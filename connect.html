<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <link rel="icon" type="image/png" sizes="512x512" href="/cmr512.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/cmr192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/cmr180.png">
  <title>Connect — CMR</title>

  <style>
    :root{
      --accent:#2b6cb0;
      --muted:#6b7280;
      --card-bg:#ffffff;
      --page-bg:#f3f4f6;
      --radius:12px;
      --max-width:980px;
      --pad:20px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }

    html,body{ margin:0; padding:0; background:var(--page-bg); color:#0f172a; -webkit-font-smoothing:antialiased; }
    .wrap{ width:100%; max-width:var(--max-width); margin:28px auto; padding:var(--pad); box-sizing:border-box; }
    .card{ background:linear-gradient(180deg,#fff,#fbfbfb); border-radius:var(--radius); padding:22px; box-shadow:0 8px 30px rgba(15,23,42,0.06); border:1px solid rgba(15,23,42,0.04); box-sizing:border-box; overflow:hidden; }

    /* Header layout: left stacked logo + title, right empty for balance on wide screens */
    .header {
      display:flex;
      gap:18px;
      align-items:flex-start;
      margin-bottom:16px;
      flex-wrap:wrap;
    }

    .header-left {
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-start;
      min-width:220px;
      box-sizing:border-box;
    }

    /* Code-based logo (top-left) */
    .code-logo-wrapper {
      display:flex;
      align-items:center;
      justify-content:flex-start;
      width:100%;
    }

    .code-logo-box {
      width:110px;
      height:52px;
      background:#071022;
      border-radius:12px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:2px 8px;
      box-sizing:border-box;
      box-shadow:0 6px 18px rgba(0,0,0,0.12);
    }

    .code-logo-cmr {
      font-family: "Montserrat", sans-serif;
      font-weight:900;
      font-size:20px;
      color:#ffffff;
      line-height:1;
      display:inline-block;
    }

    .code-logo-hub {
      font-family: "Montserrat", sans-serif;
      font-weight:320;
      font-size:22px;
      margin-left:6px;
      background:linear-gradient(90deg, #73b3cf 0%, #800000 60%, #ffffff 100%);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      -webkit-text-fill-color:transparent;
      display:inline-block;
    }

    /* Title below logo (left aligned on wide screens, centered on small screens) */
    .connect-title {
      margin:0;
      font-family: "Montserrat", sans-serif;
      font-weight:700;
      font-size:20px;
      line-height:1.15;
      color:#0f172a;
      text-align:left;
    }

    .connect-sub {
      margin:0;
      font-size:13px;
      color:var(--muted);
      text-align:left;
    }

    /* Language switcher (top-right floating inside page) */
    .lang-switcher { position:fixed; top:12px; right:12px; display:flex; gap:8px; z-index:9999; }
    .lang-btn { padding:8px 10px; border-radius:8px; border:1px solid rgba(15,23,42,0.06); background:#fff; cursor:pointer; font-weight:700; }
    .lang-btn[aria-pressed="true"] { outline:2px solid rgba(43,108,176,0.18); box-shadow:0 4px 12px rgba(43,108,176,0.06); }

    /* Form layout */
    form { margin-top:6px; display:grid; gap:14px; }
    .row { display:flex; gap:12px; }
    .col { flex:1; display:flex; flex-direction:column; gap:8px; }
    label { font-weight:700; font-size:13px; color:#0f172a; }
    input[type="text"], input[type="tel"], input[type="email"], textarea, select, input[type="number"], input[type="date"] {
      padding:10px 12px; border-radius:10px; border:1px solid rgba(15,23,42,0.06); background:#fff; font-size:14px; color:#0f172a;
      box-sizing:border-box;
    }
    textarea { min-height:160px; resize:vertical; width:100%; }
    .large-textarea { min-height:200px; font-size:15px; padding:14px; }

    .small-muted{ font-size:13px; color:var(--muted); }

    .group { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .checkbox, .radio { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; background:#fff; border:1px solid rgba(15,23,42,0.04); cursor:pointer; }
    .checkbox input, .radio input { margin:0; }

    .actions { display:flex; gap:12px; align-items:center; margin-top:6px; }
    .btn { background:var(--accent); color:#fff; padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:800; text-decoration:none; display:inline-flex; align-items:center; gap:8px; }
    .btn-ghost { background:#fff; border:1px solid rgba(15,23,42,0.06); color:#0f172a; padding:10px 12px; border-radius:10px; cursor:pointer; }

    .field-error { color:#b91c1c; font-size:13px; display:none; margin-top:6px; }

    .thankyou {
      display:none;
      margin-top:12px;
      padding:14px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(43,108,176,0.08), rgba(43,108,176,0.04));
      border:1px solid rgba(43,108,176,0.12);
      color:#0f172a;
      font-weight:700;
    }

    .address-row { display:flex; gap:8px; align-items:center; position:relative; }
    .suggestions { position:absolute; top:44px; left:0; right:0; background:#fff; border:1px solid rgba(15,23,42,0.08); border-radius:8px; max-height:220px; overflow:auto; z-index:40; box-shadow:0 8px 20px rgba(15,23,42,0.06); }
    .suggestion-item { padding:8px 10px; cursor:pointer; border-bottom:1px solid rgba(15,23,42,0.03); }
    .suggestion-item:last-child { border-bottom:0; }
    .suggestion-item:hover { background:rgba(43,108,176,0.04); }

    .kids-block { margin-top:8px; padding:10px; border-radius:10px; background:linear-gradient(180deg,#fff,#fbfbfb); border:1px solid rgba(15,23,42,0.04); }
    .kid-row { display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    .kid-row input[type="text"], .kid-row input[type="number"], .kid-row select { padding:8px 10px; }

    .teams-block { margin-top:8px; padding:10px; border-radius:10px; background:linear-gradient(180deg,#fff,#fbfbfb); border:1px solid rgba(15,23,42,0.04); display:none; }
    footer.site-footer { margin-top:18px; padding:18px 0; text-align:center; color:var(--muted); font-size:13px; }

    /* Footer placement handled outside .card in markup */

    /* Responsive adjustments */
    @media (max-width:720px){
      .header { gap:12px; }
      .header-left { min-width:0; width:100%; align-items:center; }
      .code-logo-wrapper { justify-content:center; }
      .connect-title, .connect-sub { text-align:center; }
      .row { flex-direction:column; }
      .code-logo-box { width:96px; height:46px; padding:2px 6px; }
      .code-logo-cmr, .code-logo-hub { font-size:18px; }
    }

    @media (min-width:900px){
      .header { align-items:flex-start; }
      .header-left { align-items:flex-start; }
      .connect-title { text-align:left; }
      .connect-sub { text-align:left; }
    }

    /* small visual helpers */
    .visually-hidden { position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap; }
  </style>
</head>
<body>
  <!-- Language switcher (persistent, forces translation) -->
  <div class="lang-switcher" id="langSwitcherConnect" aria-hidden="false"></div>

  <div class="wrap">
    <div class="card" role="main" aria-labelledby="connectHeading">

      <div class="header">
        <div class="header-left">
          <!-- Logo (top-left) -->
          <div class="code-logo-wrapper" aria-hidden="false">
            <div class="code-logo-box" role="img" aria-label="CMR hub logo">
              <span class="code-logo-cmr">CMR</span>
              <span class="code-logo-hub">hub</span>
            </div>
          </div>

          <!-- Title below logo -->
          <h1 id="connectHeading" class="connect-title">CONNECT</h1>
          <div class="connect-sub" id="connectIntro">Tell us a little about you</div>
        </div>

        <!-- right side left intentionally empty for balance on wide screens -->
        <div style="flex:1;"></div>
      </div>

      <form id="connectForm" name="connect" method="POST" data-netlify="true" netlify-honeypot="bot-field" novalidate>
        <input type="hidden" name="form-name" value="connect" />

        <!-- Personal info -->
        <div style="font-weight:700; margin-top:6px;" id="sectionPersonalTitle">Tell us a little about you</div>

        <div class="row">
          <div class="col">
            <label for="first" id="labelFirst">First Name</label>
            <input id="first" name="first" type="text" required aria-required="true" />
            <div class="field-error" id="first-error" aria-hidden="true"></div>
          </div>

          <div class="col">
            <label for="last" id="labelLast">Last Name</label>
            <input id="last" name="last" type="text" required aria-required="true" />
            <div class="field-error" id="last-error" aria-hidden="true"></div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="phone" id="labelPhone">Phone Number</label>
            <input id="phone" name="phone" type="tel" required aria-required="true" />
            <div class="field-error" id="phone-error" aria-hidden="true"></div>
          </div>

          <div class="col">
            <label for="email" id="labelEmail">Email (optional)</label>
            <input id="email" name="email" type="email" />
            <div class="field-error" id="email-error" aria-hidden="true"></div>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label for="gender" id="labelGender">Gender (optional)</label>
            <select id="gender" name="gender" aria-describedby="genderHelp">
              <option value="">Prefer not to say</option>
              <option value="F">F</option>
              <option value="M">M</option>
            </select>
            <div id="genderHelp" class="small-muted">Optional</div>
          </div>

          <div class="col">
            <label for="dob" id="labelDob">Date of Birth (optional)</label>
            <input id="dob" name="dob" type="date" />
          </div>
        </div>

        <!-- Where do you live -->
        <div style="font-weight:700; margin-top:6px;" id="sectionAddressTitle">Where do you live? (optional)</div>

        <div class="row">
          <div class="col">
            <label for="address" id="labelAddress">Address</label>
            <div class="address-row">
              <input id="address" name="address" type="text" placeholder="Start typing address..." aria-describedby="addressHelp" autocomplete="off" />
              <input id="apt" name="apt" type="text" placeholder="Apt / Bldg" style="width:140px;" />
              <div class="suggestions" id="addressSuggestions" style="display:none;"></div>
            </div>
            <div id="addressHelp" class="small-muted">Select an address to auto-fill city, state and ZIP.</div>

            <div id="addressExtras" style="display:none; width:100%; margin-top:8px; gap:8px; display:flex;">
              <input id="city" name="city" type="text" placeholder="City" style="flex:1;" />
              <input id="state" name="state" type="text" placeholder="State" style="width:140px;" />
              <input id="zip" name="zip" type="text" placeholder="ZIP" style="width:120px;" />
            </div>
          </div>

          <div class="col">
            <label id="labelStatus">Where are you at with CMR? (required)</label>
            <div class="group" role="radiogroup" aria-labelledby="labelStatus" style="margin-top:8px;">
              <label class="radio"><input type="radio" name="status" value="first_visit" required checked> First-time guest</label>
              <label class="radio"><input type="radio" name="status" value="second_visit"> Second-time guest</label>
              <label class="radio"><input type="radio" name="status" value="regular"> Regular attendee</label>
              <label class="radio"><input type="radio" name="status" value="member"> Member</label>
            </div>
            <div class="field-error" id="status-error" aria-hidden="true"></div>
          </div>
        </div>

        <!-- Interests -->
        <div style="font-weight:700; margin-top:6px;" id="sectionInterestTitle">I’m interested in… (optional)</div>
        <div class="group" role="group" aria-labelledby="labelInterest">
          <label class="checkbox"><input type="checkbox" name="interest" value="becoming_member"> Becoming a member</label>
          <label class="checkbox"><input type="checkbox" name="interest" value="baptism"> Baptism</label>
          <label class="checkbox"><input type="checkbox" name="interest" value="serving" id="interestServing"> Serving</label>
          <label class="checkbox"><input type="checkbox" name="interest" value="small_group"> Joining a small group / crew</label>
          <label class="checkbox"><input type="checkbox" name="interest" value="prayer"> Prayer</label>
          <label class="checkbox"><input type="checkbox" name="interest" value="learning"> Learning more about Jesus</label>
          <label class="checkbox"><input type="checkbox" name="interest" value="volunteering"> Volunteering</label>
        </div>

        <!-- Conditional: Which team interests you? (shows when Serving selected) -->
        <div id="teamsBlock" class="teams-block" aria-hidden="true">
          <div style="font-weight:700;">Which team interests you?</div>
          <div class="group" style="margin-top:8px;">
            <label class="checkbox"><input type="checkbox" name="team" value="production"> Production / Media</label>
            <label class="checkbox"><input type="checkbox" name="team" value="worship"> Worship / Band</label>
            <label class="checkbox"><input type="checkbox" name="team" value="choir"> Choir</label>
            <label class="checkbox"><input type="checkbox" name="team" value="kids"> Kids Ministry</label>
            <label class="checkbox"><input type="checkbox" name="team" value="hospitality"> Hospitality / Welcome</label>
            <label class="checkbox"><input type="checkbox" name="team" value="outreach"> Outreach</label>
            <label class="checkbox"><input type="checkbox" name="team" value="admin"> Administration</label>
          </div>
        </div>

        <!-- Children -->
        <div style="font-weight:700; margin-top:6px;">Do you have children? (optional)</div>
        <div class="group" role="radiogroup" aria-labelledby="labelKids" style="margin-top:8px;">
          <label class="radio"><input type="radio" name="hasKids" value="no" checked> No</label>
          <label class="radio"><input type="radio" name="hasKids" value="yes"> Yes</label>
        </div>

        <div id="kidsContainer" class="kids-block" style="display:none;">
          <div style="font-weight:700;">How many children</div>
          <div id="kidsList" aria-live="polite"></div>

          <div style="margin-top:8px;">
            <button type="button" class="btn-ghost" id="addKidBtn">Add child</button>
            <button type="button" class="btn-ghost" id="removeKidBtn" style="display:none;">Remove child</button>
          </div>
          <div class="small-muted" style="margin-top:8px;" id="kidsHint">You can add up to 5 children.</div>
        </div>

        <!-- Prayer -->
        <div style="font-weight:700; margin-top:6px;">How can we pray for you? (optional)</div>
        <div>
          <label id="labelPrayerSubtle" style="font-weight:600; color:var(--muted);">Prayer Request</label>
          <textarea id="prayer" name="prayer" class="large-textarea" placeholder="Share your request here"></textarea>
          <div class="small-muted" style="margin-top:6px;">This will only be shared with our pastoral team.</div>
        </div>

        <!-- Consent / Communication -->
        <div style="margin-top:10px;">
          <label style="font-weight:700;">Consent / Communication</label>
          <div style="margin-top:8px;" class="group">
            <label class="checkbox" style="width:100%;"><input type="checkbox" id="consentContact" name="consentContact" required> I agree to be contacted by CMR</label>
          </div>
          <div style="margin-top:8px;" class="group">
            <label class="checkbox" style="width:100%;"><input type="checkbox" id="consentUpdates" name="consentUpdates"> I’d like to receive church updates</label>
          </div>
          <div class="field-error" id="consentContact-error" aria-hidden="true"></div>
        </div>

        <!-- Actions -->
        <div class="actions">
          <button type="submit" class="btn" id="submitBtn">Connect with CMR</button>
          <button type="reset" class="btn-ghost" id="resetBtn">Clear</button>
        </div>

        <div class="thankyou" id="thankyou" role="status" aria-live="polite">
          Thank you — we received your submission and will get back to you soon.
        </div>
      </form>
    </div>

    <!-- Footer must be outside .card and inside .wrap -->
    <footer class="site-footer" role="contentinfo" style="margin-top:18px;">
      <div>© <span id="currentYear"></span> Centre Missionnaire La Restauration. All rights reserved.</div>
      <div style="margin-top:6px; color:var(--muted); font-size:12px;">Designed for the CMR community.</div>
    </footer>
  </div>

  <script>
    // Persisted language key
    const LANG_KEY = 'cmr_lang';

    // Translations (English + French)
    const T = {
      en: {
        connectIntro: "Tell us a little about you",
        connectHeading: "CONNECT",
        sectionPersonalTitle: "Tell us a little about you",
        labelFirst: "First Name",
        labelLast: "Last Name",
        labelPhone: "Phone Number",
        labelEmail: "Email (optional)",
        labelAddress: "Address",
        addressPlaceholder: "Start typing address...",
        addressHelp: "Select an address to auto-fill city, state and ZIP.",
        sectionAddressTitle: "Where do you live? (optional)",
        labelStatus: "Where are you at with CMR?",
        statusHelp: "Choose the option that best describes you.",
        sectionInterestTitle: "I’m interested in… (optional)",
        interest: {
          becoming_member: "Becoming a member",
          baptism: "Baptism",
          serving: "Serving",
          small_group: "Joining a small group / crew",
          prayer: "Prayer",
          learning: "Learning more about Jesus",
          volunteering: "Volunteering"
        },
        teamsTitle: "Which team interests you?",
        kidsHint: "You can add up to 5 children.",
        kidNamePlaceholder: "Child's full name",
        kidAgePlaceholder: "Date of birth",
        prayerSubtle: "Prayer Request",
        prayerPlaceholder: "Share your request here",
        submitBtn: "Connect with CMR",
        resetBtn: "Clear",
        thankYou: "Thank you — we received your submission and will get back to you soon.",
        validation: {
          required: "This field is required.",
          phoneInvalid: "Enter a valid phone number.",
          emailInvalid: "Enter a valid email address.",
          addressCityLabel: "City", addressStateLabel: "State", addressZipLabel: "ZIP",
        }
      },
      fr: {
        connectIntro: "Parlez-nous un peu de vous",
        connectHeading: "CONNECT",
        sectionPersonalTitle: "Parlez-nous un peu de vous",
        labelFirst: "Prénom",
        labelLast: "Nom",
        labelPhone: "Téléphone",
        labelEmail: "E-mail (optionnel)",
        labelAddress: "Adresse",
        addressPlaceholder: "Commencez à taper l'adresse...",
        addressHelp: "Sélectionnez une adresse pour remplir automatiquement la ville, l'état et le code postal.",
        sectionAddressTitle: "Où habitez-vous ? (optionnel)",
        labelStatus: "Où en êtes-vous avec CMR ?",
        statusHelp: "Choisissez l'option qui vous décrit le mieux.",
        sectionInterestTitle: "Je suis intéressé par… (optionnel)",
        interest: {
          becoming_member: "Devenir membre",
          baptism: "Baptême",
          serving: "Servir",
          small_group: "Rejoindre un petit groupe / équipe",
          prayer: "Prière",
          learning: "En savoir plus sur Jésus",
          volunteering: "Bénévolat"
        },
        teamsTitle: "Quelle équipe vous intéresse ?",
        kidsHint: "Vous pouvez ajouter jusqu'à 5 enfants.",
        kidNamePlaceholder: "Nom complet de l'enfant",
        kidAgePlaceholder: "Date de naissance",
        prayerSubtle: "Demande de prière",
        prayerPlaceholder: "Partagez votre demande ici",
        submitBtn: "Se connecter avec CMR",
        resetBtn: "Effacer",
        thankYou: "Merci — nous avons bien reçu votre message et nous vous contacterons bientôt.",
        validation: {
          required: "Ce champ est requis.",
          phoneInvalid: "Entrez un numéro de téléphone valide.",
          emailInvalid: "Entrez une adresse e-mail valide.",
          addressCityLabel: "Ville", addressStateLabel: "État", addressZipLabel: "Code postal",
        }
      }
    };

    // Language helpers
    function getSavedLang(){ return localStorage.getItem(LANG_KEY) || 'en'; }
    function setSavedLang(lang){
      localStorage.setItem(LANG_KEY, lang);
      applyTranslations();
      updateLangButtons();
    }

    // Build language switcher UI
    function buildLangSwitcher(){
      const container = document.getElementById('langSwitcherConnect');
      if(!container) return;
      container.innerHTML = '';

      const enBtn = document.createElement('button');
      enBtn.className = 'lang-btn';
      enBtn.id = 'lang-en';
      enBtn.type = 'button';
      enBtn.textContent = 'EN';
      enBtn.setAttribute('aria-pressed', 'false');
      enBtn.addEventListener('click', () => setSavedLang('en'));

      const frBtn = document.createElement('button');
      frBtn.className = 'lang-btn';
      frBtn.id = 'lang-fr';
      frBtn.type = 'button';
      frBtn.textContent = 'FR';
      frBtn.setAttribute('aria-pressed', 'false');
      frBtn.addEventListener('click', () => setSavedLang('fr'));

      container.appendChild(enBtn);
      container.appendChild(frBtn);

      updateLangButtons();
    }

    function updateLangButtons(){
      const lang = getSavedLang();
      const enBtn = document.getElementById('lang-en');
      const frBtn = document.getElementById('lang-fr');
      if(enBtn) enBtn.setAttribute('aria-pressed', lang === 'en' ? 'true' : 'false');
      if(frBtn) frBtn.setAttribute('aria-pressed', lang === 'fr' ? 'true' : 'false');
    }

    // Apply translations to all elements (force translate everything)
    function applyTranslations(){
      const lang = getSavedLang();
      const t = T[lang] || T.en;

      // header
      const intro = document.getElementById('connectIntro');
      if(intro) intro.textContent = t.connectIntro;
      const heading = document.getElementById('connectHeading');
      if(heading) heading.textContent = t.connectHeading;

      // section titles
      const secPersonal = document.getElementById('sectionPersonalTitle');
      if(secPersonal) secPersonal.textContent = t.sectionPersonalTitle;
      const secAddress = document.getElementById('sectionAddressTitle');
      if(secAddress) secAddress.textContent = t.sectionAddressTitle;
      const secInterest = document.getElementById('sectionInterestTitle');
      if(secInterest) secInterest.textContent = t.sectionInterestTitle;

      // labels and placeholders
      const setText = (id, text) => { const el = document.getElementById(id); if(el) el.textContent = text; };
      setText('labelFirst', t.labelFirst);
      setText('labelLast', t.labelLast);
      setText('labelPhone', t.labelPhone);
      setText('labelEmail', t.labelEmail);
      setText('labelAddress', t.labelAddress);
      const addr = document.getElementById('address');
      if(addr) addr.placeholder = t.addressPlaceholder;
      setText('labelPrayerSubtle', t.prayerSubtle);
      const prayer = document.getElementById('prayer');
      if(prayer) prayer.placeholder = t.prayerPlaceholder;
      const submit = document.getElementById('submitBtn');
      if(submit) submit.textContent = t.submitBtn;
      const reset = document.getElementById('resetBtn');
      if(reset) reset.textContent = t.resetBtn;
      const kidsHint = document.getElementById('kidsHint');
      if(kidsHint) kidsHint.textContent = t.kidsHint;

      // Interests: update visible labels (simple approach: replace text nodes)
      const interestMap = t.interest || {};
      document.querySelectorAll('input[name="interest"]').forEach((el) => {
        const parent = el.parentElement;
        if(!parent) return;
        const val = el.value;
        if(interestMap[val]) parent.childNodes.forEach(n => { if(n.nodeType === Node.TEXT_NODE) n.textContent = ' ' + interestMap[val]; });
      });

      // Teams title
      const teamsTitle = document.querySelector('#teamsBlock > div');
      if(teamsTitle) teamsTitle.textContent = t.teamsTitle || teamsTitle.textContent;

      // Kids placeholders
      document.querySelectorAll('#kidsList .kid-row').forEach((r, idx) => {
        const name = r.querySelector('input[type="text"]');
        const dob = r.querySelector('input[type="date"]');
        if(name) name.placeholder = t.kidNamePlaceholder || name.placeholder;
        if(dob) dob.placeholder = t.kidAgePlaceholder || dob.placeholder;
      });

      // Validation messages will use T[...] when needed
    }

    // Set current year
    document.getElementById('currentYear').textContent = new Date().getFullYear();

    // Validation helpers
    function showError(el, message){
      const id = (typeof el === 'string') ? el : (el && el.id ? el.id : '');
      const err = document.getElementById(id + '-error');
      if(err){ err.textContent = message; err.style.display = 'block'; err.setAttribute('aria-hidden','false'); }
      if(typeof el !== 'string' && el && el.classList) el.classList.add('input-invalid');
    }
    function clearError(el){
      const id = (typeof el === 'string') ? el : (el && el.id ? el.id : '');
      const err = document.getElementById(id + '-error');
      if(err){ err.textContent = ''; err.style.display = 'none'; err.setAttribute('aria-hidden','true'); }
      if(typeof el !== 'string' && el && el.classList) el.classList.remove('input-invalid');
    }

    function validateField(input){
      const lang = getSavedLang();
      const v = (T[lang] && T[lang].validation) ? T[lang].validation : T.en.validation;
      if(!input) return true;
      const val = (input.value || '').trim();
      if(input.required && val === ''){
        showError(input, v.required);
        return false;
      }
      if(input.type === 'tel' && val !== ''){
        const phonePattern = /^[0-9+\-\s().]{7,20}$/;
        if(!phonePattern.test(val)){ showError(input, v.phoneInvalid); return false; }
      }
      if(input.type === 'email' && val !== ''){
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if(!emailPattern.test(val)){ showError(input, v.emailInvalid); return false; }
      }
      clearError(input);
      return true;
    }

    // Address autocomplete using Nominatim (restricted to US)
    let addressTimer = null;
    async function fetchAddressSuggestions(q){
      if(!q) return [];
      const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&addressdetails=1&limit=6&countrycodes=us`;
      try {
        const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
        if(!res.ok) return [];
        const data = await res.json();
        return data;
      } catch (err) {
        console.warn('Address lookup failed', err);
        return [];
      }
    }

    function renderSuggestions(items){
      const box = document.getElementById('addressSuggestions');
      box.innerHTML = '';
      if(!items || items.length === 0){ box.style.display = 'none'; return; }
      items.forEach(it => {
        const div = document.createElement('div');
        div.className = 'suggestion-item';
        div.textContent = it.display_name;
        div.dataset.raw = JSON.stringify(it);
        div.addEventListener('click', () => selectAddressItem(it));
        box.appendChild(div);
      });
      box.style.display = 'block';
    }

    function selectAddressItem(item){
      const addrInput = document.getElementById('address');
      addrInput.value = item.display_name || '';
      const ad = item.address || {};
      const city = ad.city || ad.town || ad.village || ad.hamlet || ad.county || '';
      const state = ad.state || ad.region || ad.state_district || '';
      const postcode = ad.postcode || '';
      const extras = document.getElementById('addressExtras');
      if(extras) extras.style.display = 'flex';
      const cityEl = document.getElementById('city');
      const stateEl = document.getElementById('state');
      const zipEl = document.getElementById('zip');
      if(cityEl) cityEl.value = city;
      if(stateEl) stateEl.value = state;
      if(zipEl) zipEl.value = postcode;
      const box = document.getElementById('addressSuggestions');
      if(box) box.style.display = 'none';
    }

    function setOrCreateField(id, value){
      let el = document.getElementById(id);
      if(!el){
        el = document.createElement('input');
        el.type = 'hidden';
        el.id = id;
        el.name = id;
        document.getElementById('connectForm').appendChild(el);
      }
      el.value = value || '';
    }

    // Kids UI helpers (max 5)
    function createKidRow(index){
      const row = document.createElement('div');
      row.className = 'kid-row';
      row.dataset.index = index;

      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.name = `kid_name_${index}`;
      nameInput.placeholder = T[getSavedLang()].kidNamePlaceholder || "Child's full name";
      nameInput.required = true;
      nameInput.style.flex = '1';

      const dobInput = document.createElement('input');
      dobInput.type = 'date';
      dobInput.name = `kid_dob_${index}`;
      dobInput.required = true;
      dobInput.style.width = '160px';

      const allergyInput = document.createElement('input');
      allergyInput.type = 'text';
      allergyInput.name = `kid_allergies_${index}`;
      allergyInput.placeholder = 'Allergies / special needs (optional)';
      allergyInput.style.flex = '1';

      row.appendChild(nameInput);
      row.appendChild(dobInput);
      row.appendChild(allergyInput);
      return row;
    }

    function updateKidsPlaceholders(){
      const lang = getSavedLang();
      document.querySelectorAll('#kidsList .kid-row').forEach((r, idx) => {
        const name = r.querySelector('input[type="text"]');
        const dob = r.querySelector('input[type="date"]');
        if(name) name.placeholder = T[lang].kidNamePlaceholder || "Child's full name";
        if(dob) dob.placeholder = T[lang].kidAgePlaceholder || 'Date of birth';
      });
    }

    // DOM wiring
    document.addEventListener('DOMContentLoaded', function(){
      // Build language switcher and force translation
      buildLangSwitcher();
      applyTranslations();

      // basic elements
      const form = document.getElementById('connectForm');
      const first = document.getElementById('first');
      const last = document.getElementById('last');
      const phone = document.getElementById('phone');
      const email = document.getElementById('email');
      const addressInput = document.getElementById('address');
      const suggestionsBox = document.getElementById('addressSuggestions');

      [first,last,phone,email].forEach(f => { if(!f) return; f.addEventListener('input', ()=> validateField(f)); f.addEventListener('blur', ()=> validateField(f)); });

      // Address autocomplete wiring
      if(addressInput){
        addressInput.addEventListener('input', () => {
          const q = addressInput.value.trim();
          if(addressTimer) clearTimeout(addressTimer);
          if(!q){ suggestionsBox.style.display = 'none'; return; }
          addressTimer = setTimeout(async () => {
            const items = await fetchAddressSuggestions(q);
            renderSuggestions(items);
          }, 300);
        });
      }

      // close suggestions when clicking outside
      document.addEventListener('click', (e) => {
        if(!document.querySelector('.address-row')?.contains(e.target)) {
          if(suggestionsBox) suggestionsBox.style.display = 'none';
        }
      });

      // Teams conditional (when Serving selected)
      const teamsBlock = document.getElementById('teamsBlock');
      function updateTeamsVisibility(){
        const servingChecked = document.querySelector('input[name="interest"][value="serving"]')?.checked;
        if(servingChecked){ teamsBlock.style.display = 'block'; teamsBlock.setAttribute('aria-hidden','false'); }
        else { teamsBlock.style.display = 'none'; teamsBlock.setAttribute('aria-hidden','true'); }
      }
      document.querySelectorAll('input[name="interest"]').forEach(i => i.addEventListener('change', updateTeamsVisibility));
      updateTeamsVisibility();

      // Kids handling (max 5)
      const kidsRadios = Array.from(document.querySelectorAll('input[name="hasKids"]'));
      const kidsContainer = document.getElementById('kidsContainer');
      const kidsList = document.getElementById('kidsList');
      const addKidBtn = document.getElementById('addKidBtn');
      const removeKidBtn = document.getElementById('removeKidBtn');

      function setKidsVisibility(){
        const val = document.querySelector('input[name="hasKids"]:checked')?.value;
        if(val === 'yes'){ kidsContainer.style.display = 'block'; } else { kidsContainer.style.display = 'none'; }
      }
      kidsRadios.forEach(r => r.addEventListener('change', setKidsVisibility));
      setKidsVisibility();

      function kidCount(){ return kidsList.querySelectorAll('.kid-row').length; }

      addKidBtn.addEventListener('click', () => {
        if(kidCount() >= 5) return;
        const idx = kidCount() + 1;
        kidsList.appendChild(createKidRow(idx));
        if(kidCount() >= 1) removeKidBtn.style.display = 'inline-flex';
        if(kidCount() >= 5) addKidBtn.style.display = 'none';
        updateKidsPlaceholders();
      });

      removeKidBtn.addEventListener('click', () => {
        const rows = kidsList.querySelectorAll('.kid-row');
        if(rows.length === 0) return;
        rows[rows.length - 1].remove();
        if(kidCount() < 5) addKidBtn.style.display = 'inline-flex';
        if(kidCount() === 0) removeKidBtn.style.display = 'none';
      });

      // Submit handler
      form.addEventListener('submit', async function(e){
        e.preventDefault();

        // validate required fields
        let ok = true;
        [first,last,phone].forEach(f => { if(f) ok = validateField(f) && ok; });

        // status required (radio)
        const status = form.querySelector('input[name="status"]:checked');
        if(!status){ showError('status', T[getSavedLang()].validation.required); ok = false; } else { clearError('status'); }

        // consent required
        const consent = document.getElementById('consentContact');
        if(!consent || !consent.checked){
          showError('consentContact', T[getSavedLang()].validation.required);
          ok = false;
        } else {
          clearError('consentContact');
        }

        // kids required fields if present
        if(document.querySelector('input[name="hasKids"]:checked')?.value === 'yes'){
          const rows = kidsList.querySelectorAll('.kid-row');
          for(const r of rows){
            const name = r.querySelector('input[type="text"]');
            const dob = r.querySelector('input[type="date"]');
            if(name && (!name.value || name.value.trim() === '')){ showError(name, T[getSavedLang()].validation.required); ok = false; }
            if(dob && (!dob.value || dob.value.trim() === '')){ showError(dob, T[getSavedLang()].validation.required); ok = false; }
          }
        }

        if(!ok){
          const firstInvalid = form.querySelector('.input-invalid');
          if(firstInvalid) firstInvalid.focus();
          return;
        }

        // collect form data
        const fd = new FormData(form);

        // interests (multiple)
        const interests = Array.from(form.querySelectorAll('input[name="interest"]:checked')).map(i => i.value);
        fd.delete('interest');
        interests.forEach(i => fd.append('interest', i));

        // teams (if any)
        const teams = Array.from(form.querySelectorAll('input[name="team"]:checked')).map(i => i.value);
        teams.forEach(t => fd.append('team', t));

        // kids
        if(document.querySelector('input[name="hasKids"]:checked')?.value === 'yes'){
          const kids = Array.from(kidsList.querySelectorAll('.kid-row')).map((r, idx) => {
            const name = r.querySelector('input[type="text"]')?.value || '';
            const dob = r.querySelector('input[type="date"]')?.value || '';
            const allergies = r.querySelector('input[type="text"]')?.value || '';
            return { name, dob, allergies };
          });
          kids.forEach((k, i) => {
            fd.append(`kid_name_${i+1}`, k.name);
            fd.append(`kid_dob_${i+1}`, k.dob);
            fd.append(`kid_allergies_${i+1}`, k.allergies);
          });
        }

        // show thank you
        const thank = document.getElementById('thankyou');
        thank.style.display = 'block';
        thank.setAttribute('aria-hidden','false');

        // attempt to POST to Netlify (best-effort)
        try {
          await fetch('/', { method: 'POST', body: fd, headers: { 'Accept': 'application/json' } });
        } catch (err) {
          console.warn('Netlify submit failed (non-blocking):', err);
        }

        // reset UI
        form.reset();
        kidsList.innerHTML = '';
        removeKidBtn.style.display = 'none';
        addKidBtn.style.display = 'inline-flex';
        setKidsVisibility();
        updateTeamsVisibility();
        [first,last,phone,email].forEach(f => { if(f) clearError(f); });
        document.querySelectorAll('#city,#state,#zip').forEach(el => { if(el) el.value = ''; });
        const extras = document.getElementById('addressExtras');
        if(extras) extras.style.display = 'none';

        setTimeout(()=>{ thank.style.display = 'none'; thank.setAttribute('aria-hidden','true'); }, 8000);
      });

      // Reset handler
      const resetBtn = document.getElementById('resetBtn');
      resetBtn.addEventListener('click', () => {
        document.getElementById('kidsList').innerHTML = '';
        document.querySelectorAll('#city,#state,#zip').forEach(el => { if(el) el.value = ''; });
        [first,last,phone,email].forEach(f => { if(f) clearError(f); });
        setTimeout(() => applyTranslations(), 40);
        const extras = document.getElementById('addressExtras');
        if(extras) extras.style.display = 'none';
        updateTeamsVisibility();
      });

      // Ensure placeholders and dynamic labels reflect language
      updateKidsPlaceholders();
      updateLangButtons();
    });

    // Listen for storage changes (sync across tabs)
    window.addEventListener('storage', (e) => {
      if(e.key === LANG_KEY) {
        applyTranslations();
        updateLangButtons();
      }
    });
  </script>
</body>
</html>
